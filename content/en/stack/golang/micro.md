---
author: "wangjinbao"
title: "kratosÂæÆÊúçÂä°Ê°ÜÊû∂"
date: 2022-12-03 00:00:01
description: "‰∏ÄÂ•óËΩªÈáèÁ∫ß Go ÂæÆÊúçÂä°Ê°ÜÊû∂ÔºåÂåÖÂê´Â§ßÈáèÂæÆÊúçÂä°Áõ∏ÂÖ≥Ê°ÜÊû∂ÂèäÂ∑•ÂÖ∑"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: wangjinbao
authorEmoji: üëª
tags: 
- golang
- categories:




---

# kratos

## ‰ºòÂäø

| ÊØîÂØπÈ°π       | ÂÜÖÂÆπ                                                       |
|-----------|----------------------------------------------------------|
| Ê°ÜÊû∂Âêç	      | kratos                                                   |
| Áª¥Êä§ÂÖ¨Âè∏	     | Bilibli                                                  |
| È°πÁõÆÂú∞ÂùÄ      | https://github.com/go-kratos/kratos                      |
| starÊï∞	    | 21.7k                                                    |
| ÂºÄÊ∫êÊó∂Èó¥	     | 2019Âπ¥                                                    |
| ÊúçÂä°Ê≤ªÁêÜ      | ÊúçÂä°Ê≥®ÂÜå/ÂèëÁé∞„ÄÅË¥üËΩΩÂùáË°°„ÄÅÁÜîÊñ≠„ÄÅÈôêÊµÅ„ÄÅÂºÇÂ∏∏ÊÅ¢Â§ç„ÄÅÁõëÊéß„ÄÅÈìæË∑ØË∑üË∏™„ÄÅÊó•ÂøóÁ≠â                      |
| ‰º†ËæìÂçèËÆÆ	     | gRPC„ÄÅHTTP                                                |
| ÊúçÂä°ÂèëÁé∞ÊãìÂ±ïÊîØÊåÅ	 | nacos„ÄÅconsul„ÄÅetcd„ÄÅpolaris„ÄÅkubernetes„ÄÅdiscovery„ÄÅzookeeper |
| APIÂÆö‰πâ	    | ‰ªÖÊîØÊåÅProtobuf                                              |
| Ê°ÜÊû∂ÂéüÂàôÁâπÁÇπ    | ÁÆÄÂçï„ÄÅÈÄöÁî®„ÄÅÈ´òÊïà„ÄÅÁ®≥ÂÆö„ÄÅÂÅ•Â£Æ„ÄÅÈ´òÊÄßËÉΩ„ÄÅÊâ©Â±ïÊÄß„ÄÅÂÆπÈîôÊÄß„ÄÅÂ∑•ÂÖ∑                            |

## ÁâπÊÄß
+ APIS: ÂçèËÆÆÈÄö‰ø°‰ª• HTTP/gRPC ‰∏∫Âü∫Á°ÄÔºåÈÄöËøá Protobuf ËøõË°åÂÆö‰πâ
+ Errors: ÈÄöËøá Protobuf ÁöÑ Enum ‰Ωú‰∏∫ÈîôËØØÁ†ÅÂÆö‰πâÔºå‰ª•ÂèäÂ∑•ÂÖ∑ÁîüÊàêÂà§ÂÆöÊé•Âè£
+ Metadata: Âú®ÂçèËÆÆÈÄö‰ø° HTTP/gRPC ‰∏≠ÔºåÈÄöËøá Middleware ËßÑËåÉÂåñÊúçÂä°ÂÖÉ‰ø°ÊÅØ‰º†ÈÄí
+ Config: ÊîØÊåÅÂ§öÊï∞ÊçÆÊ∫êÊñπÂºèÔºåËøõË°åÈÖçÁΩÆÂêàÂπ∂Èì∫Âπ≥ÔºåÈÄöËøá Atomic ÊñπÂºèÊîØÊåÅÂä®ÊÄÅÈÖçÁΩÆ
+ Logger: Ê†áÂáÜÊó•ÂøóÊé•Âè£ÔºåÂèØÊñπ‰æøÈõÜÊàê‰∏âÊñπ log Â∫ìÔºåÂπ∂ÂèØÈÄöËøá fluentd Êî∂ÈõÜÊó•Âøó
+ Metrics: Áªü‰∏ÄÊåáÊ†áÊé•Âè£ÔºåÂèØ‰ª•ÂÆûÁé∞ÂêÑÁßçÊåáÊ†áÁ≥ªÁªüÔºåÈªòËÆ§ÈõÜÊàê Prometheus
+ Tracing: ÈÅµÂæ™ OpenTelemetry ËßÑËåÉÂÆö‰πâÔºå‰ª•ÂÆûÁé∞ÂæÆÊúçÂä°ÈìæË∑ØËøΩË∏™
+ Encoding: ÊîØÊåÅ Accept Âíå Content-Type ËøõË°åËá™Âä®ÈÄâÊã©ÂÜÖÂÆπÁºñÁ†Å
+ Transport: ÈÄöÁî®ÁöÑ HTTP/gRPC ‰º†ËæìÂ±ÇÔºåÂÆûÁé∞Áªü‰∏ÄÁöÑ Middleware Êèí‰ª∂ÊîØÊåÅ
+ Registry: ÂÆûÁé∞Áªü‰∏ÄÊ≥®ÂÜå‰∏≠ÂøÉÊé•Âè£ÔºåÂèØÊèí‰ª∂ÂåñÂØπÊé•ÂêÑÁßçÊ≥®ÂÜå‰∏≠ÂøÉ

## kratos-layoutÊñπÊ°à
kratosÂÆòÊñπÊèê‰æõ‰∫Ü‰∏ÄÂ•óÁõÆÂΩïÁªìÊûÑÊñπÊ°à
```shell
  .
‚îú‚îÄ‚îÄ Dockerfile  
‚îú‚îÄ‚îÄ LICENSE
‚îú‚îÄ‚îÄ Makefile  
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ api // ‰∏ãÈù¢Áª¥Êä§‰∫ÜÂæÆÊúçÂä°‰ΩøÁî®ÁöÑprotoÊñá‰ª∂‰ª•ÂèäÊ†πÊçÆÂÆÉ‰ª¨ÊâÄÁîüÊàêÁöÑgoÊñá‰ª∂
‚îÇ   ‚îî‚îÄ‚îÄ helloworld
‚îÇ       ‚îî‚îÄ‚îÄ v1
‚îÇ           ‚îú‚îÄ‚îÄ error_reason.pb.go
‚îÇ           ‚îú‚îÄ‚îÄ error_reason.proto
‚îÇ           ‚îú‚îÄ‚îÄ error_reason.swagger.json
‚îÇ           ‚îú‚îÄ‚îÄ greeter.pb.go
‚îÇ           ‚îú‚îÄ‚îÄ greeter.proto
‚îÇ           ‚îú‚îÄ‚îÄ greeter.swagger.json
‚îÇ           ‚îú‚îÄ‚îÄ greeter_grpc.pb.go
‚îÇ           ‚îî‚îÄ‚îÄ greeter_http.pb.go
‚îú‚îÄ‚îÄ cmd  // Êï¥‰∏™È°πÁõÆÂêØÂä®ÁöÑÂÖ•Âè£Êñá‰ª∂
‚îÇ   ‚îî‚îÄ‚îÄ server
‚îÇ       ‚îú‚îÄ‚îÄ main.go
‚îÇ       ‚îú‚îÄ‚îÄ wire.go  // Êàë‰ª¨‰ΩøÁî®wireÊù•Áª¥Êä§‰æùËµñÊ≥®ÂÖ•
‚îÇ       ‚îî‚îÄ‚îÄ wire_gen.go
‚îú‚îÄ‚îÄ configs  // ËøôÈáåÈÄöÂ∏∏Áª¥Êä§‰∏Ä‰∫õÊú¨Âú∞Ë∞ÉËØïÁî®ÁöÑÊ†∑‰æãÈÖçÁΩÆÊñá‰ª∂
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml
‚îú‚îÄ‚îÄ generate.go
‚îú‚îÄ‚îÄ go.mod
‚îú‚îÄ‚îÄ go.sum
‚îú‚îÄ‚îÄ internal  // ËØ•ÊúçÂä°ÊâÄÊúâ‰∏çÂØπÂ§ñÊö¥Èú≤ÁöÑ‰ª£Á†ÅÔºåÈÄöÂ∏∏ÁöÑ‰∏öÂä°ÈÄªËæëÈÉΩÂú®Ëøô‰∏ãÈù¢Ôºå‰ΩøÁî®internalÈÅøÂÖçÈîôËØØÂºïÁî®
‚îÇ   ‚îú‚îÄ‚îÄ biz   // ‰∏öÂä°ÈÄªËæëÁöÑÁªÑË£ÖÂ±ÇÔºåÁ±ª‰ºº DDD ÁöÑ domain Â±ÇÔºådata Á±ª‰ºº DDD ÁöÑ repoÔºåËÄå repo Êé•Âè£Âú®ËøôÈáåÂÆö‰πâÔºå‰ΩøÁî®‰æùËµñÂÄíÁΩÆÁöÑÂéüÂàô„ÄÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ biz.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ greeter.go
‚îÇ   ‚îú‚îÄ‚îÄ conf  // ÂÜÖÈÉ®‰ΩøÁî®ÁöÑconfigÁöÑÁªìÊûÑÂÆö‰πâÔºå‰ΩøÁî®protoÊ†ºÂºèÁîüÊàê
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conf.pb.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ conf.proto
‚îÇ   ‚îú‚îÄ‚îÄ data  // ‰∏öÂä°Êï∞ÊçÆËÆøÈóÆÔºåÂåÖÂê´ cache„ÄÅdb Á≠âÂ∞ÅË£ÖÔºåÂÆûÁé∞‰∫Ü biz ÁöÑ repo Êé•Âè£„ÄÇÊàë‰ª¨ÂèØËÉΩ‰ºöÊää data ‰∏é dao Ê∑∑Ê∑ÜÂú®‰∏ÄËµ∑Ôºådata ÂÅèÈáç‰∏öÂä°ÁöÑÂê´‰πâÔºåÂÆÉÊâÄË¶ÅÂÅöÁöÑÊòØÂ∞ÜÈ¢ÜÂüüÂØπË±°ÈáçÊñ∞ÊãøÂá∫Êù•ÔºåÊàë‰ª¨ÂéªÊéâ‰∫Ü DDD ÁöÑ infraÂ±Ç„ÄÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ greeter.go
‚îÇ   ‚îú‚îÄ‚îÄ server  // httpÂíågrpcÂÆû‰æãÁöÑÂàõÂª∫ÂíåÈÖçÁΩÆ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ grpc.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ http.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.go
‚îÇ   ‚îî‚îÄ‚îÄ service  // ÂÆûÁé∞‰∫Ü api ÂÆö‰πâÁöÑÊúçÂä°Â±ÇÔºåÁ±ª‰ºº DDD ÁöÑ application Â±ÇÔºåÂ§ÑÁêÜ DTO Âà∞ biz È¢ÜÂüüÂÆû‰ΩìÁöÑËΩ¨Êç¢(DTO -> DO)ÔºåÂêåÊó∂ÂçèÂêåÂêÑÁ±ª biz ‰∫§‰∫íÔºå‰ΩÜÊòØ‰∏çÂ∫îÂ§ÑÁêÜÂ§çÊùÇÈÄªËæë
‚îÇ       ‚îú‚îÄ‚îÄ README.md
‚îÇ       ‚îú‚îÄ‚îÄ greeter.go
‚îÇ       ‚îî‚îÄ‚îÄ service.go
‚îî‚îÄ‚îÄ third_party  // api ‰æùËµñÁöÑÁ¨¨‰∏âÊñπproto
    ‚îú‚îÄ‚îÄ README.md
    ‚îú‚îÄ‚îÄ google
    ‚îÇ   ‚îî‚îÄ‚îÄ api
    ‚îÇ       ‚îú‚îÄ‚îÄ annotations.proto
    ‚îÇ       ‚îú‚îÄ‚îÄ http.proto
    ‚îÇ       ‚îî‚îÄ‚îÄ httpbody.proto
    ‚îî‚îÄ‚îÄ validate
        ‚îú‚îÄ‚îÄ README.md
        ‚îî‚îÄ‚îÄ validate.proto
```

## ÂÆâË£Ö
### ‰æùËµñÁéØÂ¢ÉÔºö
1. go
2. protoc
```shell
protoc --version
libprotoc 25.0
```
3. ÂÆâË£ÖprotobufÁöÑgoÊâ©Â±ïÂ∑•ÂÖ∑ protoc-gen-go
```shell
go install google.golang.org/protobuf/cmd/protoc-gen-go
```
4. Âª∫ËÆÆÂºÄÂêØGO111MODULE
```shell
go env -w GO111MODULE=on
```
5. ÂÆâË£ÖkratosËÑöÊâãÊû∂
su root
```shell
GOPROXY=https://goproxy.io,direct go install github.com/go-kratos/kratos/cmd/kratos/v2@latest && kratos upgrade

```
6. ÂÆâË£ÖkratosÊ°ÜÊû∂
ÂàáÊç¢rootÔºåÂõ†Êï∞‰ºöÊääkratos ÊîæÂà∞binÁõÆÂΩï
`go install github.com/go-kratos/kratos/cmd/kratos/v2@latest`
È™åËØÅÔºö
```shell
kratos -v
kratos version v2.7.1
```

> PS:Êää $GOPATH/bin Âä†ÂÖ•Á≥ªÁªüÁéØÂ¢ÉÂèòÈáèPATH:
> linux:
> vim /etc/profile
> export PATH="/path/to/$GOPATH/bin:$PATH"
> source /etc/profile
## ÂàõÂª∫È°πÁõÆ

`kratos new helloworld -r https://gitee.com/go-kratos/kratos-layout.git`
```shell
kratos new helloworld -r https://gitee.com/go-kratos/kratos-layout.git
üöÄ Creating service helloworld, layout repo is https://gitee.com/go-kratos/kratos-layout.git, please wait a moment.

Ê≠£ÂÖãÈöÜÂà∞ '/Users/wangdante/.kratos/repo/gitee.com/go-kratos/kratos-layout@main'...

CREATED helloworld/.gitignore (552 bytes)
CREATED helloworld/Dockerfile (459 bytes)
CREATED helloworld/LICENSE (1066 bytes)
CREATED helloworld/Makefile (2525 bytes)
CREATED helloworld/README.md (1062 bytes)
CREATED helloworld/api/helloworld/v1/error_reason.pb.go (4991 bytes)
CREATED helloworld/api/helloworld/v1/error_reason.proto (290 bytes)
CREATED helloworld/api/helloworld/v1/greeter.pb.go (8074 bytes)
CREATED helloworld/api/helloworld/v1/greeter.proto (678 bytes)
CREATED helloworld/api/helloworld/v1/greeter_grpc.pb.go (3560 bytes)
CREATED helloworld/api/helloworld/v1/greeter_http.pb.go (2139 bytes)
CREATED helloworld/cmd/helloworld/main.go (1744 bytes)
CREATED helloworld/cmd/helloworld/wire.go (607 bytes)
CREATED helloworld/cmd/helloworld/wire_gen.go (1069 bytes)
CREATED helloworld/configs/config.yaml (266 bytes)
CREATED helloworld/go.mod (1053 bytes)
CREATED helloworld/go.sum (18535 bytes)
CREATED helloworld/internal/biz/README.md (6 bytes)
CREATED helloworld/internal/biz/biz.go (128 bytes)
CREATED helloworld/internal/biz/greeter.go (1236 bytes)
CREATED helloworld/internal/conf/conf.pb.go (20782 bytes)
CREATED helloworld/internal/conf/conf.proto (761 bytes)
CREATED helloworld/internal/data/README.md (7 bytes)
CREATED helloworld/internal/data/data.go (473 bytes)
CREATED helloworld/internal/data/greeter.go (835 bytes)
CREATED helloworld/internal/server/grpc.go (826 bytes)
CREATED helloworld/internal/server/http.go (831 bytes)
CREATED helloworld/internal/server/server.go (150 bytes)
CREATED helloworld/internal/service/README.md (10 bytes)
CREATED helloworld/internal/service/greeter.go (688 bytes)
CREATED helloworld/internal/service/service.go (136 bytes)
CREATED helloworld/openapi.yaml (1130 bytes)
CREATED helloworld/third_party/README.md (14 bytes)
CREATED helloworld/third_party/errors/errors.proto (411 bytes)
CREATED helloworld/third_party/google/api/annotations.proto (1051 bytes)
CREATED helloworld/third_party/google/api/client.proto (3395 bytes)
CREATED helloworld/third_party/google/api/field_behavior.proto (3011 bytes)
CREATED helloworld/third_party/google/api/http.proto (15140 bytes)
CREATED helloworld/third_party/google/api/httpbody.proto (2671 bytes)
CREATED helloworld/third_party/google/protobuf/any.proto (5909 bytes)
CREATED helloworld/third_party/google/protobuf/api.proto (7734 bytes)
CREATED helloworld/third_party/google/protobuf/compiler/plugin.proto (8754 bytes)
CREATED helloworld/third_party/google/protobuf/descriptor.proto (38497 bytes)
CREATED helloworld/third_party/google/protobuf/duration.proto (4895 bytes)
CREATED helloworld/third_party/google/protobuf/empty.proto (2429 bytes)
CREATED helloworld/third_party/google/protobuf/field_mask.proto (8185 bytes)
CREATED helloworld/third_party/google/protobuf/source_context.proto (2341 bytes)
CREATED helloworld/third_party/google/protobuf/struct.proto (3779 bytes)
CREATED helloworld/third_party/google/protobuf/timestamp.proto (6459 bytes)
CREATED helloworld/third_party/google/protobuf/type.proto (6126 bytes)
CREATED helloworld/third_party/google/protobuf/wrappers.proto (4042 bytes)
CREATED helloworld/third_party/openapi/v3/annotations.proto (2195 bytes)
CREATED helloworld/third_party/openapi/v3/openapi.proto (22082 bytes)
CREATED helloworld/third_party/validate/README.md (81 bytes)
CREATED helloworld/third_party/validate/validate.proto (31270 bytes)

üç∫ Project creation succeeded helloworld
üíª Use the following command to start the project üëá:

$ cd helloworld
$ go generate ./...
$ go build -o ./bin/ ./... 
$ ./bin/helloworld -conf ./configs

                        ü§ù Thanks for using Kratos
        üìö Tutorial: https://go-kratos.dev/docs/getting-started/start

```
 -r ÊåáÂÆöÊ∫ê

### Êï¥ÁêÜ‰æùËµñÂÖ≥Á≥ª
```shell
go mod tidy
go mod tidy: go.mod file indicates go 1.18, but maximum supported version is 1.17
```
ÂàáÊç¢Âà∞go 1.18ÁâàÊú¨

```shell
go mod tidy
```
### ‰æùËµñÊ≥®ÂÖ•wire
```golang
go get github.com/google/wire/cmd/wire
go generate ./..
// ÂÜôÂÖ•‰æùËµñÊ≥®ÂÖ•
wrote /Users/wangdante/D/kugou/verify-code/cmd/verify-code/wire_gen.go 
```

### Ê∑ªÂä†ÊúçÂä°
ÂÖ±Áî® go.mod ÔºåÂ§ß‰ªìÊ®°Âºè
```golang
kratos new helloworld
cd helloworld
kratos new app/user --nomod

‚îú‚îÄ‚îÄ app
‚îÇ   ‚îî‚îÄ‚îÄ user
‚îÇ       ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ       ‚îú‚îÄ‚îÄ Makefile
‚îÇ       ‚îú‚îÄ‚îÄ cmd
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ user
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ main.go
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ wire.go
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ wire_gen.go
‚îÇ       ‚îú‚îÄ‚îÄ configs
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ config.yaml
‚îÇ       ‚îú‚îÄ‚îÄ internal
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ biz
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ biz.go
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ greeter.go
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ conf
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conf.pb.go
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ conf.proto
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ data
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data.go
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ greeter.go
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ server
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ grpc.go
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ http.go
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.go
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ service
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ greeter.go
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ service.go
‚îÇ       ‚îî‚îÄ‚îÄ openapi.yaml
```

####  ‰∏Ä„ÄÅÊ∑ªÂä†ProtoÊñá‰ª∂
> kratos-layout È°πÁõÆ‰∏≠ÂØπ proto Êñá‰ª∂ËøõË°å‰∫ÜÁâàÊú¨ÂàíÂàÜÔºåÊîæÂú®‰∫Ü v1 Â≠êÁõÆÂΩï‰∏ã
```golang 
kratos proto add api/helloworld/v1/demo.proto
```
####  ‰∫å„ÄÅÁîüÊàêProto‰ª£Á†Å
```shell
# ÂèØ‰ª•Áõ¥Êé•ÈÄöËøá make ÂëΩ‰ª§ÁîüÊàê
make api

# Êàñ‰ΩøÁî® kratos cli ËøõË°åÁîüÊàê
kratos proto client api/helloworld/v1/demo.proto
```
‰ºöÂú®protoÊñá‰ª∂ÂêåÁõÆÂΩï‰∏ãÁîüÊàê:
```shell
api/helloworld/v1/demo.pb.go
api/helloworld/v1/demo_grpc.pb.go
# Ê≥®ÊÑè http ‰ª£Á†ÅÂè™‰ºöÂú® proto Êñá‰ª∂‰∏≠Â£∞Êòé‰∫Ü http Êó∂Êâç‰ºöÁîüÊàê
api/helloworld/v1/demo_http.pb.go
```
####  ‰∏â„ÄÅÁîüÊàêService‰ª£Á†Å
ÈÄöËøá proto Êñá‰ª∂ÔºåÂèØ‰ª•Áõ¥Êé•ÁîüÊàêÂØπÂ∫îÁöÑ Service ÂÆûÁé∞‰ª£Á†ÅÔºö
‰ΩøÁî® -t ÊåáÂÆöÁîüÊàêÁõÆÂΩï
```shell
kratos proto server api/helloworld/v1/demo.proto -t internal/service
```
ËæìÂá∫Ôºö
internal/service/demo.go





### ËßÑËåÉ‰ª£Á†Å (‰∏æ‰æãverify-codeÈ°πÁõÆ)
‰ΩøÁî® internal/data ÁõÆÂΩï ÂÆåÊàêÊï∞ÊçÆ(Êï∞ÊçÆÂ∫ìÔºåÁºìÂ≠òÔºåÊñá‰ª∂ÔºåOSSÔºå‰∫ëÊúçÂä°Âô®)ÁöÑÊìç‰Ωú
ÂØπredisÁöÑÊìç‰ΩúÔºåÂ∞±Â±û‰∫éÊ≠§Á±ª
##### Ê≠•È™§‰∏ÄÔºöÂú®/internal/data/data.go‰∏≠ÂÆåÊàêredisÂÆ¢Êà∑Á´ØÁöÑÂàùÂßãÂåñ
##### Ê≠•È™§‰∫åÔºö‰ΩøÁî®ÈÖçÁΩÆÊñá‰ª∂ÔºåÂÆåÊàêredisÊúçÂä°Âô®‰ø°ÊÅØÁöÑËÆæÁΩÆ
```golang
// ProviderSet is data providers.
var ProviderSet = wire.NewSet(NewData, NewGreeterRepo)

// Data .
type Data struct {
	// TODO wrapped database client
	Rdb *redis.Client
}

// NewData .
func NewData(c *conf.Data, logger log.Logger) (*Data, func(), error) {
	data := &Data{}
	//ÂàùÂßãÂåñRdb
	//ËøûÊé•redis,‰ΩøÁî®ÊúçÂä°ÁöÑÈÖçÁΩÆÔºåcÂ∞±ÊòØËß£Êûê‰πãÂêéÁöÑÂèòÈáè
	redisURL := fmt.Sprintf("redis://%s/1?dial_timeout=%d", c.Redis.Addr, 1)
	options, err := redis.ParseURL(redisURL)
	if err != nil {
		data.Rdb = nil
	}
	// new client ‰∏ç‰ºöÁ´ãÂç≥ËøûÊé•ÔºåÂª∫Á´ãÂÆ¢Êà∑Á´ØÔºåÈúÄË¶ÅÊâßË°åÂëΩ‰ª§Êó∂Êâç‰ºöËøûÊé•
	data.Rdb = redis.NewClient(options)

	cleanup := func() {
		//Ê∏ÖÁêÜ‰∫ÜredisËøûÊé•
		_ = data.Rdb.Close()
		log.NewHelper(logger).Info("closing the data resources")
	}
	return data, cleanup, nil
}
```
##### Ê≠•È™§‰∏âÔºöÂàõÂª∫data‰∏≠Áî®‰∫éÂÆåÊàêÊï∞ÊçÆÊìç‰ΩúÁöÑÂØπË±°(ÂÆû‰Ωì)
1. Êñ∞Âª∫ internal/data/customer.go
2. ÂÆö‰πâÂÆåÊàêÂêéÔºå‰∏∫‰æùËµñÊ≥®ÂÖ• wire Êèê‰æõ provider
3. Âú® internal/data/data.go ‰∏≠

##### Ê≠•È™§ÂõõÔºöÂÆåÊàêËÆæÁΩÆÈ™åËØÅÁ†ÅÁöÑ‰∏öÂä°ÈÄªËæë‰ª£Á†Å
Êõ¥Êñ∞ internal/data/customer.go Êñ∞Âª∫
`func (cd CustomerData) SetVerifyCode(telephone, code string, ex int64) error` ÊñπÊ≥ïÔºåÁî®‰∫é ÂÆåÊàêËÆæÁΩÆ

##### Ê≠•È™§‰∫îÔºöÊõ¥Êñ∞ CustomerService ÁöÑÂÆö‰πâÔºå‰∏é CustomerData Âª∫Á´ãÂÖ≥ËÅî
`internal/service/customer.go`
‰øÆÊîπÂ¶Ç‰∏ãÔºö
```golang
type CustomerService struct {
	pb.UnimplementedCustomerServer
	cd *data.CustomerData //‰øÆÊîπ
}

func NewCustomerService(cd *data.CustomerData) *CustomerService {
	return &CustomerService{
		cd: cd, //‰øÆÊîπ
	}
}
```

##### Ê≠•È™§ÂÖ≠ÔºöË∞ÉÁî® CustomerData ‰∏≠ÂÆö‰πâÁöÑÊñπÊ≥ïÔºåÂÆûÁé∞ËÆæÁΩÆÈ™åËØÅÁ†ÅÁºìÂ≠òÁöÑ‰∏öÂä°ÈÄªËæë
1. Ê∑ªÂä† Req Âíå Resp

customer.proto Êñá‰ª∂‰∏≠ Ê∑ªÂä† Req Âíå Resp ÁªìÊûÑÔºåÁîüÊàêÊõ¥Êñ∞customer.pd.go Êñá‰ª∂Ôºö
```proto
message GetVerifyCodeReq{}
message GetVerifyCodeResp{}
```
2. Êõ¥Êñ∞customer.pb.goÊñá‰ª∂Ôºö
```shell
kratos proto client api/helloworld/v1/demo.proto
```
3. GetVerifyCodeÊñπÊ≥ï



>ÊØèÊ¨°Êõ¥Êñ∞ProviderSetÂêéÈÉΩË¶ÅÈáçÊñ∞Êõ¥Êñ∞‰æùËµñÊ≥®ÂÖ•
> go generate ./...

Êü•Áúãmakefile:
```shell
make help
sudo make init
sudo make api
```
ËøêË°åÈ°πÁõÆ
```shell
kratos run 
# ‰øÆÊîπÈÖçÁΩÆÊñá‰ª∂ config.yaml Á´ØÂè£
2023/11/21 19:29:48 maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
DEBUG msg=config loaded: config.yaml format: yaml
INFO ts=2023-11-21T19:29:48+08:00 caller=http/server.go:302 service.id=wangdeMacBook-Pro.local service.name= service.version= trace.id= span.id= msg=[HTTP] server listening on: [::]:8022
INFO ts=2023-11-21T19:29:48+08:00 caller=grpc/server.go:205 service.id=wangdeMacBook-Pro.local service.name= service.version= trace.id= span.id= msg=[gRPC] server listening on: [::]:9022

```

ÊâìÂåÖÈ°πÁõÆ
```shell
$go build -o ./bin/ ./...
./helloworld 
2023/12/05 11:05:26 maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
panic: stat ../../configs: no such file or directory
cp -r ../configs ../../

./helloworld 
2023/12/05 11:07:05 maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
DEBUG msg=config loaded: config.yaml format: yaml
INFO ts=2023-12-05T11:07:05+08:00 caller=http/server.go:317 service.id=wangdeMacBook-Pro.local service.name= service.version= trace.id= span.id= msg=[HTTP] server listening on: [::]:8000
INFO ts=2023-12-05T11:07:05+08:00 caller=grpc/server.go:212 service.id=wangdeMacBook-Pro.local service.name= service.version= trace.id= span.id= msg=[gRPC] server listening on: [::]:9006
INFO ts=2023-12-05T11:07:15+08:00 caller=biz/greeter.go:44 service.id=wangdeMacBook-Pro.local service.name= service.version= trace.id= span.id= msg=CreateGreeter: eric
INFO ts=2023-12-05T11:07:16+08:00 caller=biz/greeter.go:44 service.id=wangdeMacBook-Pro.local service.name= service.version= trace.id= span.id= msg=CreateGreeter: eric

```


## Â§ßÈõÜÊàêdemo
### ÂàõÂª∫ÊúçÂä°customer
```shell
kratos new customer -r https://gitee.com/go-kratos/kratos-layout.git  
```

### Êï¥ÁêÜ‰æùËµñÂåÖ
```shell
cd customer
go mod tidy
```

### ‰æùËµñÊ≥®ÂÖ•wire
```shell
go get github.com/google/wire/cmd/wire
// ÂÜôÂÖ•‰æùËµñÊ≥®ÂÖ•
go generate ./...
wire: customer/cmd/customer: wrote /Users/wangdante/D/kugou/kratos_backend/customer/cmd/customer/wire_gen.go
```

### È™åËØÅÂêØÂä®

>PS kratos run ÁöÑÊó∂ÂÄôÊä•ÈîôÔºö
> missing go.sum entry for module providing package golang.org/x/sync/errgroup (imported by github.com/go-kratos/kratos/v2); to add:
> Ëß£ÂÜ≥ÊñπÊ≥ïÔºö go get golang.org/x/sync/errgroup

‰øÆÊîπ configs/config.yaml Á´ØÂè£Ôºö
```yaml
server:
  http:
    addr: 0.0.0.0:8600
    timeout: 1s
  grpc:
    addr: 0.0.0.0:9600
```

ÂºÄÂêØÈ°πÁõÆÔºö`kratos run` --Âú®customerÁõÆÂΩï‰∏ã

È™åËØÅËÆøÈóÆÔºöhttp://127.0.0.1:8600/helloworld/123

### Ê∑ªÂä†protoÊñá‰ª∂
```shell
kratos proto add api/customer/customer.proto
```

### Â¢ûÂä†Ë∑ØÁî±‰ª£Á†Å
vim api/customer/customer.proto ‰∏≠Ê∑ªÂä†ÂÜÖÂÆπÂ¶Ç‰∏ãÔºö
```proto
// ÂØºÂÖ•ÂåÖ
import "google/api/annotations.proto";
...
//Ëé∑ÂèñÈ™åËØÅÁ†Å
	rpc GetVerifyCode (GetVerifyCodeReq)returns(GetVerifyCodeResp){
		option (google.api.http)={
			get: "/customer/get-verify-code"
		};
	}
...
message GetVerifyCodeReq {
	string Telephone = 1;
}
message GetVerifyCodeResp {
	int64 Code = 1;
	string Message = 2;
	string Data = 3;
}
```

### Â¢ûÂä†ÂÆ¢Êà∑Á´Ø‰ª£Á†Å(client)
```shell
kratos proto client api/customer/customer.proto 
```

### Â¢ûÂä†ÊúçÂä°Á´Ø‰ª£Á†Å(server)
```shell
kratos proto server api/customer/customer.proto
#ÊàñËÄÖÊåáÂÆöÁõÆÂΩï -t
kratos proto server api/customer/customer.proto -t internal/service
```

### httpÊúçÂä°‰∏≠Âä†customerÊúçÂä°
‰øÆÊîπ internal/server/http.go ÔºöÂÜÖÂÆπÂ¶Ç‰∏ãÔºö
```go
import customer2 "customer/api/customer"
...
func NewHTTPServer(c *conf.Server, customerService *service.CustomerService, greeter *service.GreeterService, logger log.Logger) *http.Server {
...
srv := http.NewServer(opts...)
// Ê≥®ÂÜåcustomerÁöÑhttpÁöÑÊúçÂä°
customer2.RegisterCustomerHTTPServer(srv, customerService)
v1.RegisterGreeterHTTPServer(srv, greeter)
...
```

### (grpcÊúçÂä°‰∏≠Âä†customerÊúçÂä°)
‰øÆÊîπ internal/server/grpc.go ÔºöÂÜÖÂÆπÂ¶Ç‰∏ãÔºö
```go
import customer2 "customer/api/customer"
...
func NewGRPCServer(c *conf.Server, customerService *service.CustomerService, greeter *service.GreeterService, logger log.Logger) *grpc.Server {
...
srv := grpc.NewServer(opts...)
// Ê≥®ÂÜåcustomerÁöÑgrpcÁöÑÊúçÂä°
customer2.RegisterCustomerServer(srv, customerService)
v1.RegisterGreeterServer(srv, greeter)
```

### ‰øÆÊîπ‰æùËµñÊ≥®ÂÖ•providerSet
‰øÆÊîπ internal/service/service.go ÂÜÖÂÆπÂ¶Ç‰∏ãÔºö
```go
var ProviderSet = wire.NewSet(NewCustomerService, NewGreeterService)
```



### Âü∫‰∫éwireÊ≥®ÂÖ•‰æùËµñ
ÈõÜÊàêÊ†πÁõÆÂΩï‰∏ã kratos_backend ÊâßË°å
```shell
go get github.com/google/wire/cmd/wire
```

kratos_backend/customerÁõÆÂΩï‰∏ãÊâßË°åÔºö
```shell
go generate ./...
wire: customer/cmd/customer: wrote /Users/wangdante/D/kugou/kratos_backend/customer/cmd/customer/wire_gen.go

```


>PS:Êä•Èîô
> go: cannot find main module, but found .git/config in /Users/wangdante/D/kugou/kratos_backend to create a module there, run:go mod init
>Ëß£ÂÜ≥ÊñπÊ≥ïÔºö
> go mod init customer
> go mod tidy
> 

### ÂêØÂä®
customerÁõÆÂΩï‰∏ãÊâßË°åÔºö
```shell
kratos run
2023/12/15 18:45:29 maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
DEBUG msg=config loaded: config.yaml format: yaml
INFO ts=2023-12-15T18:45:29+08:00 caller=grpc/server.go:205 service.id=wangdeMacBook-Pro.local service.name= service.version= trace.id= span.id= msg=[gRPC] server listening on: [::]:9600
INFO ts=2023-12-15T18:45:29+08:00 caller=http/server.go:302 service.id=wangdeMacBook-Pro.local service.name= service.version= trace.id= span.id= msg=[HTTP] server listening on: [::]:8600

```
#### ÊµãËØïhttpÊúçÂä°
ÊµèËßàÂô®ËæìÂÖ•Ôºö
http://127.0.0.1:8600/customer/get-verify-code
ËøîÂõûÔºö
```shell
{
"Code": "0",
"Message": "",
"Data": ""
}
```
#### ÊµãËØïgrpcÊúçÂä°
‰ΩøÁî®apifoxÂ∑•ÂÖ∑
1. Ê≠•È™§‰∏ÄÔºöËÆæÁΩÆ.protoÊñá‰ª∂
`/Users/wangdante/D/kugou/kratos_backend/customer/api/customer/customer.proto`
2. Ê≠•È™§‰∫åÔºöËÆæÁΩÆ‰æùËµñÂÖ≥Á≥ªÁõÆÂΩï
Êää third_party ÁõÆÂΩï‰∏≠ÁöÑ googleÂ§çÂà∂‰∏Ä‰ªΩÂà∞È°πÁõÆcustomerÊ†πÁõÆÂΩï‰∏ã
`/Users/wangdante/D/kugou/kratos_backend/customer`
3. Ê≠•È™§‰∏âÔºöËÆæÁΩÆÁéØÂ¢É
ÂºÄÂèëÁéØÂ¢ÉÔºö127.0.0.1:9600
4. Ê≠•È™§ÂõõÔºöËØ∑Ê±ÇgRPCÂπ∂‰º†ÂèÇ
ÂèÇÊï∞Ôºö
```shell
{
    "Telephone":"13510116521"
}
```
ËøîÂõûÂÄºÔºö
```shell
{
    "Code": "0",
    "Message": "13510116521Ëé∑ÂèñÈ™åËØÅÁ†ÅÊàêÂäü",
    "Data": ""
}
```
