---
author: "Karson"
title: "k8så®è·µä¸æ€»ç»“-5(service)"
date: 2023-06-23
description: "k8så®è·µä¸æ€»ç»“(service)"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: Karson
authorEmoji: ğŸ‘»
tags:
- k8s
categories:
- k8s
---
##  serviceæœåŠ¡
### serviceçš„å®šä¹‰ï¼š
é€šè¿‡ `label` å’Œ `selector` å¯¹å¤–æä¾›è®¿é—®çš„`ä¸€ç»„pod`ï¼Œç›¸å½“äºå¾®æœåŠ¡

svcåªèƒ½æä¾› <font color='cyan'>4å±‚è´Ÿè½½å‡è¡¡</font> èƒ½åŠ›,æ²¡æœ‰7å±‚è´Ÿè½½å‡è¡¡ï¼Œ
ä¹Ÿå°±æ˜¯åªèƒ½é€šè¿‡ `IP + ç«¯å£` çš„æ–¹å¼è®¿é—®ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½é€šè¿‡ `ä¸»æœºå æˆ– åŸŸå` æ–¹å¼è®¿é—®

### serviceçš„ç±»å‹ 
4ç§ç±»å‹ï¼š
### 1. ClusterIP: 
é»˜è®¤ç±»å‹ï¼Œè‡ªåŠ¨åˆ†é…ä¸€ä¸ªä»…ClusterIP<font color='cyan'>å†…éƒ¨å¯è®¿é—®</font>çš„ <font color='cyan'>è™šæ‹ŸIP</font>
### 2. NodePort:
åœ¨ClusterIPçš„åŸºç¡€ä¸Šï¼Œä¸ºserviceåœ¨æ¯å°æœºå™¨ä¸Šç»‘å®šä¸€ä¸ªç«¯å£ï¼Œé€šè¿‡ <font color='cyan'>NodeIP : NodePort</font>æ¥è®¿é—®æœåŠ¡
### 3. LoadBalancer:
åœ¨NodePortçš„åŸºç¡€ä¸Šï¼Œcloud provider(äº‘æœåŠ¡å•†)æä¾›ä¸€ä¸ªå¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶æŠŠè¯·æ±‚è½¬å‘åˆ° <font color='cyan'>NodeIP : NodePort</font>
### 4. ExternalName:
æŠŠé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡å¼•å…¥åˆ°é›†ç¾¤å†…éƒ¨ï¼Œåœ¨é›†ç¾¤å†…éƒ¨ç›´æ¥ä½¿ç”¨ã€‚

![/images/docImages/ks12.png](/images/docImages/ks12.png)

è¯´æ˜ï¼š
1-ç›‘å¬æœåŠ¡ä¸ç«¯ç‚¹ï¼š
é€šè¿‡ kubeproxy å®ç°çš„ï¼Œkubeproxyç›‘å¬åŒ¹é…åˆ°çš„podä¸­çš„ä¿¡æ¯å¹¶å†™å…¥iptablesä¸­ã€‚
2-å®¢æˆ·ç«¯è®¿é—®svcï¼š
é€šè¿‡ iptables ä¸­çš„ç»‘å®šä¿¡æ¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„pod

## ä»£ç†æ¨¡å‹çš„åˆ†ç±»
> PS : ä¸ºä»€ä¹ˆä»£ç†ä¸ä½¿ç”¨ round-robin DNS?
> ç­”ï¼šDNSæ›´æ–°ä¸åŠæ—¶ç”Ÿæ•ˆï¼Œä¼šæœ‰ç¼“å­˜
1. userspace(k8s1.0ç‰ˆæœ¬)
2. iptables(k8s1.2ç‰ˆæœ¬)
3. ipvs(k8s1.14ç‰ˆæœ¬)

```shell
sudo vim svc-deployment.yaml
sudo kubectl apply -f svc-deployment.yaml
```
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  selector:
    matchLabels:
      app: myapp
  replicas: 3
  template:
    metadata:
      labels:
        app: myapp
        release: stabel
    spec:
      containers:
        - name: myapp
          image: nginx:1.25
          ports:
            - containerPort: 80
```

```shell
sudo vim myapp-service.yaml
sudo kubectl apply -f myapp-service.yaml
```
```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  type: ClusterIP
  selector:
    app: myapp
    release: stabel
  ports:
    - port: 80
      targetPort: 80
```

## Headless Service(ç‰¹æ®Šçš„clusterIP)
æœ‰æ—¶ä¸éœ€è¦æˆ–ä¸æƒ³è¦è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠå•ç‹¬çš„ Service IPã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼ŒIPçš„å€¼ä¸º "None" æ¥åˆ›å»º Headless Serviceï¼Œè¿™ç±»serviceæœåŠ¡ï¼ŒIP/kube-proxyä¸ä¼šå¤„ç†å®ƒä»¬ï¼Œä¹Ÿä¸ä¼šè´Ÿè½½å‡è¡¡ã€‚

```shell
sudo vim myapp-svc-headless.yaml
sudo kubectl apply -f myapp-svc-headless.yaml
```
```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-headless
  namespace: default
spec:
  selector:
    app: myapp
  clusterIP: "None"
  ports:
    - port: 80
      targetPort: 80
```
æŸ¥çœ‹
```shell
$ kubectl get pod -n kube-system -o wide
```
```shell
# å®‰è£…dig
$ yum install -y bind-utils
$ dig -t A myapp-headless.default.svc.cluster.local. @10.96.0.10

```

## ExternalNameåŸŸåè®¿é—®
```shell
sudo vim ex.yaml
sudo kubectl apply -f ex.yaml
```
```yaml
kind: Service
apiVersion: v1
metadata:
  name: my-service-1
  namespace: default
spec:
  type: ExternalName
  externalName: i.jarvenwang.com
```