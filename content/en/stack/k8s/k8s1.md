---
author: "wangjinbao"
title: "æœ¬åœ°éƒ¨ç½²k8sé›†ç¾¤åŠåŒ…ç®¡ç†å·¥å…·ä½¿ç”¨"
date: 2022-06-22
description: "æœ¬åœ°éƒ¨ç½²k8sé›†ç¾¤åŠåŒ…ç®¡ç†å·¥å…·ä½¿ç”¨ã€‚"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: wangjinbao
authorEmoji: ğŸ‘»
tags:
- docker
categories:
- minikube
- helm
---


## 1 minikubeæ­å»ºkubernetesé›†ç¾¤ç¯å¢ƒ
### 1.1 å®‰è£…minikube
[minikube](https://minikube.sigs.k8s.io/)çš„å®‰è£…ï¼š

```bash
# macOS
brew install minikube

# Windows
choco install minikube

# Linux
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
```

ä¹Ÿå¯ä»¥åˆ°å®˜ç½‘ç›´æ¥ä¸‹è½½å®‰è£…åŒ…æ¥å®‰è£…ï¼š[https://minikube.sigs.k8s.io/docs/start/](https://minikube.sigs.k8s.io/docs/start/)


### 1.2 å¯åŠ¨minikube

```bash
# å¯åŠ¨minikube
minikube start
```


## 2. Multipasså’Œk3sæ­å»ºkubernetesé›†ç¾¤ç¯å¢ƒ

[minikube](https://minikube.sigs.k8s.io/)åªèƒ½ç”¨æ¥åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ªå•èŠ‚ç‚¹çš„kubernetesé›†ç¾¤ç¯å¢ƒï¼Œ
ä¸‹é¢ä»‹ç»å¦‚ä½•ä½¿ç”¨[Multipass](https://multipass.run/)å’Œ[k3s](https://k3s.io/)æ¥æ­å»ºä¸€ä¸ªå¤šèŠ‚ç‚¹çš„kubernetesé›†ç¾¤ç¯å¢ƒï¼Œ



### 2.1 Multipassä»‹ç»
[Multipass](https://multipass.run/)æ˜¯ä¸€ä¸ªè½»é‡çº§çš„è™šæ‹Ÿæœºç®¡ç†å·¥å…·ï¼Œ
å¯ä»¥ç”¨æ¥åœ¨æœ¬åœ°å¿«é€Ÿåˆ›å»ºå’Œç®¡ç†è™šæ‹Ÿæœºï¼Œ
ç›¸æ¯”äºVirtualBoxæˆ–è€…VMwareè¿™æ ·çš„è™šæ‹Ÿæœºç®¡ç†å·¥å…·ï¼Œ
[Multipass](https://multipass.run/)æ›´åŠ è½»é‡å¿«é€Ÿï¼Œ
è€Œä¸”å®ƒè¿˜æä¾›äº†ä¸€äº›å‘½ä»¤è¡Œå·¥å…·æ¥æ–¹ä¾¿æˆ‘ä»¬ç®¡ç†è™šæ‹Ÿæœºã€‚
å®˜æ–¹ç½‘å€: [https://Multipass.run/](https://multipass.run/)

### 2.2 å®‰è£…Multipass

```bash
# macOS
brew install multipass

# Windows
choco install multipass

# Linux
sudo snap install multipass
```

### 2.3 Multipasså¸¸ç”¨å‘½ä»¤

å…³äºMultipassçš„ä¸€äº›å¸¸ç”¨å‘½ä»¤æˆ‘ä»¬å¯ä»¥é€šè¿‡`multipass help`æ¥æŸ¥çœ‹ï¼Œ
è¿™é‡Œå¤§å®¶åªéœ€è¦è®°ä½å‡ ä¸ªå¸¸ç”¨çš„å‘½ä»¤å°±å¯ä»¥äº†ï¼Œ
```bash
# æŸ¥çœ‹å¸®åŠ©
multipass help
multipass help <command>

# åˆ›å»ºä¸€ä¸ªåå­—å«åšk3sçš„è™šæ‹Ÿæœº
multipass launch --name k3s

# åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œå‘½ä»¤
multipass exec k3s -- ls -l

# è¿›å…¥è™šæ‹Ÿæœºå¹¶æ‰§è¡Œshell
multipass shell k3s

# æŸ¥çœ‹è™šæ‹Ÿæœºçš„ä¿¡æ¯
multipass info k3s

# åœæ­¢è™šæ‹Ÿæœº
multipass stop k3s

# å¯åŠ¨è™šæ‹Ÿæœº
multipass start k3s

# åˆ é™¤è™šæ‹Ÿæœº
multipass delete k3s

# æ¸…ç†è™šæ‹Ÿæœº
multipass purge

# æŸ¥çœ‹è™šæ‹Ÿæœºåˆ—è¡¨
multipass list

# æŒ‚è½½ç›®å½•ï¼ˆå°†æœ¬åœ°çš„~/kubernetes/masterç›®å½•æŒ‚è½½åˆ°è™šæ‹Ÿæœºä¸­çš„~/masterç›®å½•ï¼‰
multipass mount ~/kubernetes/master master:~/master

```

Multipassæœ‰ä¸ªé—®é¢˜ï¼Œ
æ¯æ¬¡M1èŠ¯ç‰‡çš„Macå‡çº§ä¹‹åMultipassçš„è™šæ‹Ÿæœºéƒ½ä¼šè¢«åˆ é™¤ï¼Œ
ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰é‡åˆ°ç±»ä¼¼çš„é—®é¢˜ã€‚
```bash
# é•œåƒä½ç½®
/var/root/Library/Application Support/multipassd/qemu/vault/instances
# é…ç½®æ–‡ä»¶
/var/root/Library/Application Support/multipassd/qemu/multipassd-vm-instances.json
```

### 2.4 k3sä»‹ç»

[k3s](https://k3s.io/) æ˜¯ä¸€ä¸ªè½»é‡çº§çš„[Kubernetes](https://kubernetes.io/)å‘è¡Œç‰ˆï¼Œå®ƒæ˜¯ [Rancher Labs](https://www.rancher.com/) æ¨å‡ºçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œ
æ—¨åœ¨ç®€åŒ–[Kubernetes](https://kubernetes.io/)çš„å®‰è£…å’Œç»´æŠ¤ï¼ŒåŒæ—¶å®ƒè¿˜æ˜¯CNCFè®¤è¯çš„[Kubernetes](https://kubernetes.io/)å‘è¡Œç‰ˆã€‚

### 2.5 åˆ›å»ºå’Œé…ç½®masterèŠ‚ç‚¹

é¦–å…ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨multipassåˆ›å»ºä¸€ä¸ªåå­—å«åšk3sçš„è™šæ‹Ÿæœºï¼Œ
```bash
multipass launch --name k3s --cpus 2 --memory 8G --disk 10G
```
è™šæ‹Ÿæœºåˆ›å»ºå®Œæˆä¹‹åï¼Œ
å¯ä»¥é…ç½®SSHå¯†é’¥ç™»å½•ï¼Œ
ä¸è¿‡è¿™ä¸€æ­¥å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œ
å³ä½¿ä¸é…ç½®ä¹Ÿå¯ä»¥é€šè¿‡`multipass exec`æˆ–è€…`multipass shell`å‘½ä»¤æ¥è¿›å…¥è™šæ‹Ÿæœºï¼Œ
ç„¶åæˆ‘ä»¬éœ€è¦åœ¨masterèŠ‚ç‚¹ä¸Šå®‰è£…[k3s](https://k3s.io/)ï¼Œ

ä½¿ç”¨[k3s](https://k3s.io/)æ­å»ºkubernetesé›†ç¾¤éå¸¸ç®€å•ï¼Œ
åªéœ€è¦æ‰§è¡Œä¸€æ¡å‘½ä»¤å°±å¯ä»¥åœ¨å½“å‰èŠ‚ç‚¹ä¸Šå®‰è£…[k3s](https://k3s.io/)ï¼Œ
æ‰“å¼€åˆšåˆšåˆ›å»ºçš„k3sè™šæ‹Ÿæœºï¼Œ
æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥å®‰è£…ä¸€ä¸ª[k3s](https://k3s.io/)çš„masterèŠ‚ç‚¹ï¼Œ

```bash
# å®‰è£…k3sçš„masterèŠ‚ç‚¹
curl -sfL https://get.k3s.io | sh -
```

å›½å†…ç”¨æˆ·å¯ä»¥æ¢æˆä¸‹é¢çš„å‘½ä»¤ï¼Œä½¿ç”¨ranherçš„é•œåƒæºæ¥å®‰è£…ï¼š
```bash
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -
```

å®‰è£…å®Œæˆä¹‹åï¼Œå¯ä»¥é€šè¿‡`kubectl`å‘½ä»¤æ¥æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€ï¼Œ
```bash
sudo kubectl get nodes
```

### 2.6 åˆ›å»ºå’Œé…ç½®workerèŠ‚ç‚¹

æ¥ä¸‹æ¥éœ€è¦åœ¨è¿™ä¸ªmasterèŠ‚ç‚¹ä¸Šè·å–ä¸€ä¸ªtokenï¼Œ
ç”¨æ¥ä½œä¸ºåˆ›å»ºworkerèŠ‚ç‚¹æ—¶çš„ä¸€ä¸ªè®¤è¯å‡­è¯ï¼Œ
å®ƒä¿å­˜åœ¨`/var/lib/rancher/k3s/server/node-token`è¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œ
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`sudo cat`å‘½ä»¤æ¥æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œ
```bash
sudo cat /var/lib/rancher/k3s/server/node-token
```

å°†TOKENä¿å­˜åˆ°ä¸€ä¸ªç¯å¢ƒå˜é‡ä¸­
```bash
TOKEN=$(multipass exec k3s sudo cat /var/lib/rancher/k3s/server/node-token)
```

ä¿å­˜masterèŠ‚ç‚¹çš„IPåœ°å€
```bash
MASTER_IP=$(multipass info k3s | grep IPv4 | awk '{print $2}')
```
ç¡®è®¤ï¼š
```bash
echo $MASTER_IP
```

ä½¿ç”¨åˆšåˆšçš„`TOKEN`å’Œ`MASTER_IP`æ¥åˆ›å»ºä¸¤ä¸ªworkerèŠ‚ç‚¹
å¹¶æŠŠå®ƒä»¬åŠ å…¥åˆ°é›†ç¾¤ä¸­
```bash
# åˆ›å»ºä¸¤ä¸ªworkerèŠ‚ç‚¹çš„è™šæ‹Ÿæœº
multipass launch --name worker1 --cpus 2 --memory 8G --disk 10G
multipass launch --name worker2 --cpus 2 --memory 8G --disk 10G

# åœ¨workerèŠ‚ç‚¹è™šæ‹Ÿæœºä¸Šå®‰è£…k3s
 for f in 1 2; do
     multipass exec worker$f -- bash -c "curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL=\"https://$MASTER_IP:6443\" K3S_TOKEN=\"$TOKEN\" sh -"
 done
```

è¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªå¤šèŠ‚ç‚¹çš„kubernetesé›†ç¾¤çš„æ­å»ºã€‚

## 3. åœ¨çº¿å®éªŒç¯å¢ƒ
[Killercoda](https://killercoda.com/)

[Play-With-K8s](https://labs.play-with-k8s.com/)

## 4. kubectlå¸¸ç”¨å‘½ä»¤

### 4.1 åŸºç¡€ä½¿ç”¨

```bash
# æŸ¥çœ‹å¸®åŠ©
kubectl --help

# æŸ¥çœ‹APIç‰ˆæœ¬
kubectl api-versions

# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
kubectl cluster-info
```

### 4.2 èµ„æºçš„åˆ›å»ºå’Œè¿è¡Œ
```bash
# åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªæŒ‡å®šçš„é•œåƒ
kubectl run NAME --image=image [params...]
# e.g. åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªåå­—ä¸ºnginxçš„Pod
kubectl run nginx --image=nginx

# æ ¹æ®YAMLé…ç½®æ–‡ä»¶æˆ–è€…æ ‡å‡†è¾“å…¥åˆ›å»ºèµ„æº
kubectl create RESOURCE
# e.g.
# æ ¹æ®nginx.yamlé…ç½®æ–‡ä»¶åˆ›å»ºèµ„æº
kubectl create -f nginx.yaml
# æ ¹æ®URLåˆ›å»ºèµ„æº
kubectl create -f https://k8s.io/examples/application/deployment.yaml
# æ ¹æ®ç›®å½•ä¸‹çš„æ‰€æœ‰é…ç½®æ–‡ä»¶åˆ›å»ºèµ„æº
kubectl create -f ./dir

# é€šè¿‡æ–‡ä»¶åæˆ–æ ‡å‡†è¾“å…¥é…ç½®èµ„æº
kubectl apply -f (-k DIRECTORY | -f FILENAME | stdin)
# e.g.
# æ ¹æ®nginx.yamlé…ç½®æ–‡ä»¶åˆ›å»ºèµ„æº
kubectl apply -f nginx.yaml
```

### 4.3 æŸ¥çœ‹èµ„æºä¿¡æ¯

```bash
# æŸ¥çœ‹é›†ç¾¤ä¸­æŸä¸€ç±»å‹çš„èµ„æº
kubectl get RESOURCE
# å…¶ä¸­ï¼ŒRESOURCEå¯ä»¥æ˜¯ä»¥ä¸‹ç±»å‹ï¼š
kubectl get pods / po         # æŸ¥çœ‹Pod
kubectl get svc               # æŸ¥çœ‹Service
kubectl get deploy            # æŸ¥çœ‹Deployment
kubectl get rs                # æŸ¥çœ‹ReplicaSet
kubectl get cm                # æŸ¥çœ‹ConfigMap
kubectl get secret            # æŸ¥çœ‹Secret
kubectl get ing               # æŸ¥çœ‹Ingress
kubectl get pv                # æŸ¥çœ‹PersistentVolume
kubectl get pvc               # æŸ¥çœ‹PersistentVolumeClaim
kubectl get ns                # æŸ¥çœ‹Namespace
kubectl get node              # æŸ¥çœ‹Node
kubectl get all               # æŸ¥çœ‹æ‰€æœ‰èµ„æº

# åé¢è¿˜å¯ä»¥åŠ ä¸Š -o wide å‚æ•°æ¥æŸ¥çœ‹æ›´å¤šä¿¡æ¯
kubectl get pods -o wide

# æŸ¥çœ‹æŸä¸€ç±»å‹èµ„æºçš„è¯¦ç»†ä¿¡æ¯
kubectl describe RESOURCE NAME
# e.g. æŸ¥çœ‹åå­—ä¸ºnginxçš„Podçš„è¯¦ç»†ä¿¡æ¯
kubectl describe pod nginx
```

### 4.4 èµ„æºçš„ä¿®æ”¹ã€åˆ é™¤å’Œæ¸…ç†

```bash
# æ›´æ–°æŸä¸ªèµ„æºçš„æ ‡ç­¾
kubectl label RESOURCE NAME KEY_1=VALUE_1 ... KEY_N=VALUE_N
# e.g. æ›´æ–°åå­—ä¸ºnginxçš„Podçš„æ ‡ç­¾
kubectl label pod nginx app=nginx

# åˆ é™¤æŸä¸ªèµ„æº
kubectl delete RESOURCE NAME
# e.g. åˆ é™¤åå­—ä¸ºnginxçš„Pod
kubectl delete pod nginx

# åˆ é™¤æŸä¸ªèµ„æºçš„æ‰€æœ‰å®ä¾‹
kubectl delete RESOURCE --all
# e.g. åˆ é™¤æ‰€æœ‰Pod
kubectl delete pod --all

# æ ¹æ®YAMLé…ç½®æ–‡ä»¶åˆ é™¤èµ„æº
kubectl delete -f FILENAME
# e.g. æ ¹æ®nginx.yamlé…ç½®æ–‡ä»¶åˆ é™¤èµ„æº
kubectl delete -f nginx.yaml

# è®¾ç½®æŸä¸ªèµ„æºçš„å‰¯æœ¬æ•°
kubectl scale --replicas=COUNT RESOURCE NAME
# e.g. è®¾ç½®åå­—ä¸ºnginxçš„Deploymentçš„å‰¯æœ¬æ•°ä¸º3
kubectl scale --replicas=3 deployment/nginx

# æ ¹æ®é…ç½®æ–‡ä»¶æˆ–è€…æ ‡å‡†è¾“å…¥æ›¿æ¢æŸä¸ªèµ„æº
kubectl replace -f FILENAME
# e.g. æ ¹æ®nginx.yamlé…ç½®æ–‡ä»¶æ›¿æ¢åå­—ä¸ºnginxçš„Deployment
kubectl replace -f nginx.yaml
```

### 4.5 è°ƒè¯•å’Œäº¤äº’

```bash
# è¿›å…¥æŸä¸ªPodçš„å®¹å™¨ä¸­
kubectl exec [-it] POD [-c CONTAINER] -- COMMAND [args...]
# e.g. è¿›å…¥åå­—ä¸ºnginxçš„Podçš„å®¹å™¨ä¸­ï¼Œå¹¶æ‰§è¡Œ/bin/bashå‘½ä»¤
kubectl exec -it nginx -- /bin/bash

# æŸ¥çœ‹æŸä¸ªPodçš„æ—¥å¿—
kubectl logs [-f] [-p] [-c CONTAINER] POD [-n NAMESPACE]
# e.g. æŸ¥çœ‹åå­—ä¸ºnginxçš„Podçš„æ—¥å¿—
kubectl logs nginx

# å°†æŸä¸ªPodçš„ç«¯å£è½¬å‘åˆ°æœ¬åœ°
kubectl port-forward POD [LOCAL_PORT:]REMOTE_PORT [...[LOCAL_PORT_N:]REMOTE_PORT_N]
# e.g. å°†åå­—ä¸ºnginxçš„Podçš„80ç«¯å£è½¬å‘åˆ°æœ¬åœ°çš„8080ç«¯å£
kubectl port-forward nginx 8080:80

# è¿æ¥åˆ°ç°æœ‰çš„æŸä¸ªPodï¼ˆå°†æŸä¸ªPodçš„æ ‡å‡†è¾“å…¥è¾“å‡ºè½¬å‘åˆ°æœ¬åœ°ï¼‰
kubectl attach POD -c CONTAINER
# e.g. å°†åå­—ä¸ºnginxçš„Podçš„æ ‡å‡†è¾“å…¥è¾“å‡ºè½¬å‘åˆ°æœ¬åœ°
kubectl attach nginx

# è¿è¡ŒæŸä¸ªPodçš„å‘½ä»¤
kubectl run NAME --image=image -- COMMAND [args...]
# e.g. è¿è¡Œåå­—ä¸ºnginxçš„Pod
kubectl run nginx --image=nginx -- /bin/bash

```

## 5. Portainerçš„å®‰è£…å’Œä½¿ç”¨
[Portainer](https://www.portainer.io/) æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å®¹å™¨ç®¡ç†å·¥å…·ï¼Œ
å¯ä»¥ç”¨æ¥ç®¡ç†Dockerå’ŒKubernetesï¼Œ
å®ƒæä¾›äº†ä¸€ä¸ªWebç•Œé¢æ¥æ–¹ä¾¿æˆ‘ä»¬ç®¡ç†å®¹å™¨ï¼Œ
å®˜æ–¹ç½‘å€: [https://www.portainer.io/](https://www.portainer.io/)
### 5.1 å®‰è£…Portainer
```bash
# åˆ›å»ºä¸€ä¸ªåå­—å«åšportainerçš„è™šæ‹Ÿæœº
multipass launch --name portainer --cpus 2 --memory 8G --disk 10G
```
å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å®‰è£…åœ¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„masterèŠ‚ç‚¹ä¸Šï¼Œ

```bash
# åœ¨masterèŠ‚ç‚¹ä¸Šå®‰è£…portainerï¼Œå¹¶å°†å…¶æš´éœ²åœ¨NodePort 30777ä¸Š
kubectl apply -n portainer -f https://downloads.portainer.io/ce2-19/portainer.yaml
```

æˆ–è€…ä½¿ç”¨Helmå®‰è£…
```bash
# ä½¿ç”¨Helmå®‰è£…Portainer
helm upgrade --install --create-namespace -n portainer portainer portainer/portainer --set tls.force=true
```
ç„¶åç›´æ¥è®¿é—® `https://localhost:30779/` æˆ–è€… `http://localhost:30777/` å°±å¯ä»¥äº†ï¼Œ

## 6. Helmçš„å®‰è£…å’Œä½¿ç”¨
[Helm](https://helm.sh/) æ˜¯ä¸€ä¸ªKubernetesçš„åŒ…ç®¡ç†å·¥å…·ï¼Œ
å¯ä»¥ç”¨æ¥ç®¡ç†Kubernetesçš„åº”ç”¨ï¼Œ
å®ƒæä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·æ¥æ–¹ä¾¿æˆ‘ä»¬ç®¡ç†Kubernetesçš„åº”ç”¨ï¼Œ
å®˜æ–¹ç½‘å€: [https://helm.sh/](https://helm.sh/)
### 6.1 å®‰è£…Helm

ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼š
```bash
# macOS
brew install helm

# Windows
choco install kubernetes-helm
# æˆ–è€…
scoop install helm

# Linuxï¼ˆDebian/Ubuntuï¼‰
curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
sudo apt-get install apt-transport-https --yes
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt-get update
sudo apt-get install helm

# Linuxï¼ˆCentOS/Fedoraï¼‰
sudo dnf install helm

# Linuxï¼ˆSnapï¼‰
sudo snap install helm --classic

# Linuxï¼ˆFreeBSDï¼‰
pkg install helm



```
ä½¿ç”¨è„šæœ¬å®‰è£…
```bash
$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
$ chmod 700 get_helm.sh
$ ./get_helm.sh
```
æˆ–è€…
```bash
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```

