---
author: "wangjinbao"
title: "k8så®è·µä¸æ€»ç»“-4(æ§åˆ¶å™¨)"
date: 2023-06-23
description: "k8så®è·µä¸æ€»ç»“(æ§åˆ¶å™¨)"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: wangjinbao
authorEmoji: ğŸ‘»
tags:
- k8s
categories:
- k8s
---
##  k8sæ§åˆ¶å™¨
å®šä¹‰ï¼š k8sä¸­å†…å»ºäº†å¾ˆå¤šçš„controller(æ§åˆ¶å™¨)ï¼Œç›¸å½“äºä¸€ä¸ªçŠ¶æ€æœºï¼Œç”¨æ¥æ§åˆ¶podçš„å…·ä½“çŠ¶æ€å’Œè¡Œä¸º

### æ§åˆ¶å™¨ç±»å‹
+ ReplicationControllerå’ŒReplicaSet
ç”¨æ¥ç»´æŒç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°
+ Deployment
å£°æ˜å¼å®šä¹‰æ–¹æ³•ï¼Œç”¨æ¥æ›¿ä»£RSæ›´æ–¹ä¾¿çš„ç®¡ç†åº”ç”¨
åœºæ™¯ï¼š
1. å®šä¹‰Deploymentæ¥åˆ›å»ºPodå’ŒReplicaSet(å…ˆåˆ›å»ºrsï¼Œrså†ç®¡ç†pod)
2. æ»šåŠ¨å‡çº§å’Œå›æ»šåº”ç”¨(é€šè¿‡rsçš„ç‰ˆæœ¬åˆ é™¤æ—§pod)
3. æ‰©å®¹å’Œç¼©å®¹
4. æš‚åœå’Œç»§ç»­Deployment
>PS:
> å‘½ä»¤å¼ç¼–ç¨‹ï¼šè¿‡ç¨‹æ­¥éª¤ä¸€ä¸€æ­¥å®šä¹‰å¥½ create
> å£°æ˜å¼ç¼–ç¨‹ï¼šä¸è¦è¿‡ç¨‹ï¼Œåªè¦ç»“æœ apply
+ DaemonSet
ç¡®ä¿ å…¨éƒ¨ æˆ– ä¸€äº› Nodeä¸Šè¿è¡Œä¸€ä¸ªpodçš„å‰¯æœ¬ã€‚
å…¸å‹ç”¨æ³•ï¼š
1. è¿è¡Œé›†ç¾¤å­˜å‚¨ daemon,å¦‚ æ¯ä¸ªNodeä¸Šè¿è¡Œglusterdã€ceph
2. åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†daemonï¼Œå¦‚ fluentdã€logstash
3. åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œç›‘æ§daemonï¼Œå¦‚ prometheus node exporter
+ Job/CronJob
ä¿è¯ä»»åŠ¡ï¼ŒæˆåŠŸç»“æŸï¼Œå¦‚ï¼š * * * * *ã€‚1 å®šæ—¶ä»»åŠ¡ 2 å‘¨æœŸä»»åŠ¡
+ StateFulSet
åº”ç”¨åœºæ™¯ï¼š
1. ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨
2. ç¨³å®šçš„ç½‘ç»œæ ‡è¯†
3. æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•

+ Horizontal Pod Autoscaling
å¹³æ»‘æ›´æ–°

## Deployment

### 1.åˆ›å»º 
`kubectl create -f xxx-deployment.yaml --record`
### 2.æ‰©å®¹
`scale ... --replicas 10`
```shell
kubectl scale deployment nginx-deployment --replicas 10
```
### 3.å¦‚æœé›†ç¾¤æ”¯æŒHPVçš„è¯ï¼Œå¯ä»¥ä¸ºDeploymentè®¾ç½®è‡ªåŠ¨æ‰©å±•
`kubectl autoscale deployment nginx-deployment --min=10 --max=15 --cpu-percent=80`
### 4.æ›´æ–°é•œåƒæ¯”è¾ƒç®€å•
`kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1`
æŸ¥çœ‹æ›´æ–°è¿‡ç¨‹çš„å‘½ä»¤ï¼š
`kubectl rollout status XX `
`kubectl rollout status deployment/nginx-deployment`
### 5.å›æ»š
rollout undo
`kubectl rollout undo deployment/nginx-deployment`

## Deploymentçš„æ›´æ–°ç­–ç•¥
+ Deployment ä¿è¯å‡çº§æ—¶åªæœ‰ä¸€å®šæ•°é‡çš„podæ˜¯downçš„ã€‚ ç¡®ä¿è‡³å°‘æœ‰æ¯”æœŸæœ›çš„podæ•°é‡å°‘ä¸€ä¸ªæ˜¯upçŠ¶æ€ï¼ˆæœ€å¤šä¸€ä¸ªä¸å¯ç”¨ï¼‰
+ ç¡®ä¿æœ€å¤šæ¯”æœŸæœ›çš„podæ•°æ®å¤šä¸€ä¸ªpodæ˜¯upçš„
+ æ›´æ–°25%çš„pod

## Rollver(å¤šä¸ªå¹¶è¡Œ)
å‡è®¾è¦åˆ›å»º5ä¸ªå‰¯æœ¬çš„Deploymentï¼Œå½“è¿˜æœ‰3ä¸ªæ²¡åˆ›å»ºå¥½é‡Œï¼Œæ›´æ–°äº†ç­–ç•¥ï¼ŒDeploymentä¼šç›´æ¥æ€æ­»å·²ç»åˆ›å»ºå¥½çš„podï¼Œç›´æ¥æ›´æ–°æœ€æ–°çš„5ä¸ªpod

## å›é€€(Deployment)
```shell
kubectl set image deployment/nginx-deployment nginx=nginx:1.91
kubectl rollout status deployment/nginx-deployment
kubectl get pods
kubectl rollout history deployment/nginx-deployment
kubectl rollout undo deployment/nginx-deployment
## æŒ‡å®š å†å²ç‰ˆæœ¬
kubectl rollout undo deployment/nginx-deployment --to-version=2
## æš‚åœ deployment çš„æ›´æ–°
kubectl rollout pause deployment/nginx-deployment
```

## æ¸…ç†(Policy)
è®¾ç½® spec.revisonHistoryLimit é¡¹æ¥æŒ‡å®š deployment æœ€å¤šä¿ç•™å¤šå°‘ revision å†å²è®°å½•ã€‚
é»˜è®¤çš„ä¼šä¿ç•™æ‰€æœ‰çš„revsion;è®¾ç½®ä¸º0ï¼Œä¸å…è®¸å›é€€

## DaemonSet
ä¾‹å­ï¼š
```yaml
...
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: daemonset-example
  labels:
    app: deamonset
spec:
  selector:
    matchLabels:
      name: deamonset-exaple
  template:
    metadata:
      labels:
        name: deamonset-exaple
    spec:
      containers:
        - name: deamonset-example
          image: XXXmyapp:v1

...
```

## Job
ä¾‹å­ï¼š
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: pi
spec:
  template:
    metadata:
        name: pi
    spec:
      containers:
        - name: pi
          image: perl
          command: ["perl","-Mbignum=bpi","-wle","print bpi(2000)"] 
      restartPolicy: Never
```