---
author: "wangjinbao"
title: "k8så®è·µä¸æ€»ç»“-6(ingress)"
date: 2023-06-23
description: "k8så®è·µä¸æ€»ç»“(ingress)"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: wangjinbao
authorEmoji: ğŸ‘»
tags:
- k8s
categories:
- k8s
---
##  ingress

![/images/docImages/ks13.png](/images/docImages/ks13.png)

![/images/docImages/ks14.png](/images/docImages/ks14.png)

## ingressæ¦‚è¿°
å®šä¹‰ï¼šæä¾›å¤–éƒ¨è®¿é—®å†…éƒ¨é›†ç¾¤çš„ <font color='cyan'>è®¿é—®å…¥å£</font>ï¼Œ<font color='cyan'>è·¯ç”±è§„åˆ™çš„é›†åˆ</font>ï¼Œå°†å¤–éƒ¨çš„httpæˆ–httpsè¯·æ±‚è½¬å‘åˆ°é›†ç¾¤å†…éƒ¨çš„serviceä¸Šã€‚

## ingress-nginxç»„æˆ
ä¸‰ä¸ªç»„ä»¶ï¼š
+ åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨
  é€šå¸¸ä»¥serviceçš„portæ–¹å¼è¿è¡Œï¼Œæ¥æ”¶å¹¶æŒ‰ç…§ingresså®šä¹‰çš„è§„åˆ™è¿›è¡Œè½¬å‘ï¼Œå¸¸ç”¨çš„æœ‰nginxï¼ŒHaproxyï¼ŒTraefikç­‰ï¼Œ<font color='cyan'>nginx</font> æœ€å¸¸ç”¨
+ Ingress Controller
  ç›‘å¬APIServerï¼Œæ ¹æ®ç”¨æˆ·ç¼–å†™çš„ingressè§„åˆ™ï¼ˆ<font color='cyan'>ç¼–å†™ingressçš„yamlæ–‡ä»¶</font>ï¼‰ï¼Œ<font color='cyan'>åŠ¨æ€åœ°å»æ›´æ”¹nginxæœåŠ¡çš„é…ç½®æ–‡ä»¶</font>ï¼Œå¹¶ä¸”reloadé‡è½½ä½¿å…¶ç”Ÿæ•ˆï¼Œæ­¤è¿‡ç¨‹æ˜¯è‡ªåŠ¨åŒ–çš„ï¼ˆé€šè¿‡luaè„šæœ¬æ¥å®ç°ï¼‰
+ Ingress
  <font color='cyan'>å°†nginxçš„é…ç½®æŠ½è±¡æˆä¸€ä¸ªIngresså¯¹è±¡</font>ï¼Œå½“ç”¨æˆ·æ¯æ·»åŠ ä¸€ä¸ªæ–°çš„æœåŠ¡ï¼Œåªéœ€è¦ç¼–å†™ä¸€ä¸ªæ–°çš„ingressçš„yamlæ–‡ä»¶å³å¯


## ingress-nginxçš„å·¥ä½œåŸç†
å·¥ä½œåŸç†ï¼š
1. ingress controlleré€šè¿‡å’Œk8s apiäº¤äº’ï¼Œ<font color='cyan'>**åŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ingressè§„åˆ™å˜åŒ–**</font>
2. ç„¶åè¯»å–å®ƒï¼ŒæŒ‰ç…§<font color='cyan'>**è‡ªå®šä¹‰çš„è§„åˆ™**</font>ï¼Œè§„åˆ™å°±æ˜¯å†™æ˜äº†<font color='cyan'>**å“ªä¸ªåŸŸåå¯¹åº”å“ªä¸ªservice**</font>ï¼Œç”Ÿæˆä¸€æ®µnginxé…ç½®
3. åœ¨å†™åˆ°nginx-ingress-controllerçš„podé‡Œï¼Œè¿™ä¸ª<font color='cyan'>**Ingress controllerçš„podé‡Œè¿è¡Œç€ä¸€ä¸ªNginxæœåŠ¡**</font>ï¼Œæ§åˆ¶å™¨ä¼šæŠŠç”Ÿæˆçš„<font color='cyan'>**nginxé…ç½®å†™å…¥/etc/nginx.conf**</font>æ–‡ä»¶ä¸­
4. ç„¶å<font color='cyan'>**reloadä¸€ä¸‹ä½¿é…ç½®ç”Ÿæ•ˆ**</font>ï¼Œä»¥æ­¤è¾¾åˆ°åˆ†é…å’ŒåŠ¨æ€æ›´æ–°é—®é¢˜

## ingress-nginxè§£å†³ç”Ÿäº§ç¯å¢ƒé—®é¢˜
1. åŠ¨æ€é…ç½®æœåŠ¡ï¼š
   å¦‚æœæŒ‰ç…§ä¼ ç»Ÿæ–¹å¼ï¼Œå½“æ–°å¢åŠ ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æµé‡å…¥å£åŠ ä¸€ä¸ªåå‘ä»£ç†æŒ‡å‘æˆ‘ä»¬æ–°çš„æœåŠ¡ï¼Œè€Œä½¿ç”¨ingressï¼Œåªéœ€è¦é…ç½®å¥½ingressï¼Œå½“æœåŠ¡å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨æ³¨å†Œåˆ°ingresså½“ä¸­ï¼Œä¸éœ€è¦é¢å¤–çš„æ“ä½œ
2. å‡å°‘ä¸å¿…è¦çš„Portæš´éœ²ï¼š
   æˆ‘ä»¬çŸ¥é“éƒ¨ç½²k8sæ—¶ï¼Œæ˜¯éœ€è¦å…³é—­é˜²ç«å¢™çš„ï¼Œä¸»è¦åŸå› æ˜¯k8sçš„å¾ˆå¤šæœåŠ¡ä¼šä»¥nodeportæ–¹å¼æ˜ å°„å‡ºå»ï¼Œè¿™æ ·å¯¹äºå®¿ä¸»æœºæ¥è¯´æ˜¯éå¸¸çš„ä¸å®‰å…¨çš„ï¼Œè€Œingresså¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦å°†ingressè‡ªèº«æœåŠ¡æ˜ å°„å‡ºå»ï¼Œå°±å¯ä»£ç†åç«¯æ‰€æœ‰çš„æœåŠ¡ï¼Œåˆ™åç«¯æœåŠ¡ä¸éœ€è¦æ˜ å°„å‡ºå»

## éƒ¨ç½²Ingress-nginx

### ä¸€ã€éƒ¨ç½²ingress-nginxå‰å‡†å¤‡

#### åˆ›å»ºnamespace
```shell
sudo vim ns.yaml
sudo kubectl apply -f ns.yaml
```
ns.yaml:
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-test
```
æŸ¥çœ‹ï¼š
```shell
ubuntu@k3s:~/ingress_nginx$ sudo kubectl  get ns
NAME              STATUS   AGE
kube-system       Active   10d
kube-public       Active   10d
kube-node-lease   Active   10d
default           Active   10d
ingress-test      Active   13m <<<
```

#### åˆ›å»ºnginxçš„deploymentåŠserviceèµ„æº
```shell
sudo vim nginx.yaml
sudo kubectl apply -f nginx.yaml
```
nginx.yaml:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: ingress-test
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 3
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.25
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  namespace: ingress-test
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 32133
```
æŸ¥çœ‹ï¼š
```shell
ubuntu@k3s:~/ingress_nginx$ sudo kubectl get svc -n ingress-test
NAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
nginx-svc   NodePort   10.43.71.238   <none>        80:32133/TCP   18m
# æŸ¥çœ‹
ubuntu@k3s:~/ingress_nginx$ curl 10.43.71.238
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
...
```
æµ‹è¯•å¤–éƒ¨é€šè¿‡nodeportæ–¹å¼èƒ½å¦è®¿é—®åˆ°é›†ç¾¤å†…éƒ¨åº”ç”¨ï¼š
```shell
multipass list
Name                    State             IPv4             Image
primary                 Stopped           --               Ubuntu 24.04 LTS
k3s                     Running           192.168.74.2     Ubuntu 24.04 LTS
                                          10.42.0.0
                                          10.42.0.1
worker1                 Stopped           --               Ubuntu 24.04 LTS
worker2                 Stopped           --               Ubuntu 24.04 LTS
```
è®¿é—® `http://192.168.74.2:32133/` æˆåŠŸæ˜¾ç¤ºOK

![/images/docImages/ks5.png](/images/docImages/ks5.png)

### äºŒã€åˆ›å»ºingress-nginx
ç½‘é¡µä¸Šå®Œæ•´çš„å‘½ä»¤æ˜¯ç›´æ¥æ‰§è¡Œè¯¥yamlæ–‡ä»¶ï¼Œæˆ‘ä»¬å…ˆä¸è¦æ‰§è¡Œï¼Œå…ˆå°†è¯¥yamlæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ä¸»æœºä¸Š
```shell
wget  https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.28.0/deploy/static/mandatory.yaml
```
deploy.yamlï¼š
```yaml
apiVersion: v1
kind: Namespace
metadata:
  labels:
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
  name: ingress-nginx
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx
  namespace: ingress-nginx
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-admission
  namespace: ingress-nginx
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx
  namespace: ingress-nginx
rules:
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - configmaps
  - pods
  - secrets
  - endpoints
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses/status
  verbs:
  - update
- apiGroups:
  - networking.k8s.io
  resources:
  - ingressclasses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - coordination.k8s.io
  resourceNames:
  - ingress-nginx-leader
  resources:
  - leases
  verbs:
  - get
  - update
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - create
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - list
  - watch
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-admission
  namespace: ingress-nginx
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  - endpoints
  - nodes
  - pods
  - secrets
  - namespaces
  verbs:
  - list
  - watch
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses/status
  verbs:
  - update
- apiGroups:
  - networking.k8s.io
  resources:
  - ingressclasses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - list
  - watch
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-admission
rules:
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - validatingwebhookconfigurations
  verbs:
  - get
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx
  namespace: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ingress-nginx
subjects:
- kind: ServiceAccount
  name: ingress-nginx
  namespace: ingress-nginx
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-admission
  namespace: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ingress-nginx-admission
subjects:
- kind: ServiceAccount
  name: ingress-nginx-admission
  namespace: ingress-nginx
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx
subjects:
- kind: ServiceAccount
  name: ingress-nginx
  namespace: ingress-nginx
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-admission
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx-admission
subjects:
- kind: ServiceAccount
  name: ingress-nginx-admission
  namespace: ingress-nginx
---
apiVersion: v1
data:
  allow-snippet-annotations: "false"
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-controller
  namespace: ingress-nginx
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  externalTrafficPolicy: Local
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - appProtocol: http
    name: http
    port: 80
    protocol: TCP
    targetPort: http
  - appProtocol: https
    name: https
    port: 443
    protocol: TCP
    targetPort: https
  selector:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-controller-admission
  namespace: ingress-nginx
spec:
  ports:
  - appProtocol: https
    name: https-webhook
    port: 443
    targetPort: webhook
  selector:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  minReadySeconds: 0
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app.kubernetes.io/component: controller
      app.kubernetes.io/instance: ingress-nginx
      app.kubernetes.io/name: ingress-nginx
  strategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app.kubernetes.io/component: controller
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/part-of: ingress-nginx
        app.kubernetes.io/version: 1.10.1
    spec:
      containers:
      - args:
        - /nginx-ingress-controller
        - --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller
        - --election-id=ingress-nginx-leader
        - --controller-class=k8s.io/ingress-nginx
        - --ingress-class=nginx
        - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller
        - --validating-webhook=:8443
        - --validating-webhook-certificate=/usr/local/certificates/cert
        - --validating-webhook-key=/usr/local/certificates/key
        - --enable-metrics=false
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LD_PRELOAD
          value: /usr/local/lib/libmimalloc.so
        image: registry.k8s.io/ingress-nginx/controller:v1.10.1@sha256:e24f39d3eed6bcc239a56f20098878845f62baa34b9f2be2fd2c38ce9fb0f29e
        imagePullPolicy: IfNotPresent
        lifecycle:
          preStop:
            exec:
              command:
              - /wait-shutdown
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        name: controller
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        - containerPort: 443
          name: https
          protocol: TCP
        - containerPort: 8443
          name: webhook
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          requests:
            cpu: 100m
            memory: 90Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - ALL
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 101
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - mountPath: /usr/local/certificates/
          name: webhook-cert
          readOnly: true
      dnsPolicy: ClusterFirst
      nodeSelector:
        kubernetes.io/os: linux
      serviceAccountName: ingress-nginx
      terminationGracePeriodSeconds: 300
      volumes:
      - name: webhook-cert
        secret:
          secretName: ingress-nginx-admission
---
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-admission-create
  namespace: ingress-nginx
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: admission-webhook
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/part-of: ingress-nginx
        app.kubernetes.io/version: 1.10.1
      name: ingress-nginx-admission-create
    spec:
      containers:
      - args:
        - create
        - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc
        - --namespace=$(POD_NAMESPACE)
        - --secret-name=ingress-nginx-admission
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.4.1@sha256:36d05b4077fb8e3d13663702fa337f124675ba8667cbd949c03a8e8ea6fa4366
        imagePullPolicy: IfNotPresent
        name: create
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65532
          seccompProfile:
            type: RuntimeDefault
      nodeSelector:
        kubernetes.io/os: linux
      restartPolicy: OnFailure
      serviceAccountName: ingress-nginx-admission
---
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-admission-patch
  namespace: ingress-nginx
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: admission-webhook
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/part-of: ingress-nginx
        app.kubernetes.io/version: 1.10.1
      name: ingress-nginx-admission-patch
    spec:
      containers:
      - args:
        - patch
        - --webhook-name=ingress-nginx-admission
        - --namespace=$(POD_NAMESPACE)
        - --patch-mutating=false
        - --secret-name=ingress-nginx-admission
        - --patch-failure-policy=Fail
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.4.1@sha256:36d05b4077fb8e3d13663702fa337f124675ba8667cbd949c03a8e8ea6fa4366
        imagePullPolicy: IfNotPresent
        name: patch
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65532
          seccompProfile:
            type: RuntimeDefault
      nodeSelector:
        kubernetes.io/os: linux
      restartPolicy: OnFailure
      serviceAccountName: ingress-nginx-admission
---
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: nginx
spec:
  controller: k8s.io/ingress-nginx
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.10.1
  name: ingress-nginx-admission
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: ingress-nginx-controller-admission
      namespace: ingress-nginx
      path: /networking/v1/ingresses
  failurePolicy: Fail
  matchPolicy: Equivalent
  name: validate.nginx.ingress.kubernetes.io
  rules:
  - apiGroups:
    - networking.k8s.io
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - ingresses
  sideEffects: None
```
> PS : é•œåƒæ‹‰å–åœ°å€ï¼š
> ```yaml
> ...
> nodeSelector:
>         kubernetes.io/os: linux
>       containers:
>         - name: nginx-ingress-controller
>           image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.28.0 <<<(å›½å¤–é•œåƒåœ°å€)
> ...
> ```
> å›½å†…é•œåƒå¯ä»¥ä½¿ç”¨ï¼š
> ```shell
> docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:0.28.0
> ```
> å¯¼å…¥é•œåƒåŒ…-å°†nginx-ingress-controller.0.28.0é•œåƒåŒ…å¯¼å…¥é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹
> docker save -o nginx-xxx.tar nginx-ingress:latest
> docker load -i nginx.tar

```shell
sudo vim deploy.yaml
ubuntu@k3s:~/ingress_nginx$ sudo kubectl apply -f deploy.yaml
namespace/ingress-nginx created
serviceaccount/ingress-nginx created
serviceaccount/ingress-nginx-admission created
role.rbac.authorization.k8s.io/ingress-nginx created
role.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrole.rbac.authorization.k8s.io/ingress-nginx created
clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
rolebinding.rbac.authorization.k8s.io/ingress-nginx created
rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
configmap/ingress-nginx-controller created
service/ingress-nginx-controller created
service/ingress-nginx-controller-admission created
deployment.apps/ingress-nginx-controller created
job.batch/ingress-nginx-admission-create created
job.batch/ingress-nginx-admission-patch created
ingressclass.networking.k8s.io/nginx created
validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created
```

æŸ¥çœ‹è¿è¡Œæƒ…å†µï¼š
```shell
ubuntu@k3s:~/ingress_nginx$ sudo kubectl get pod -n ingress-nginx -o wide
NAME                                        READY   STATUS      RESTARTS   AGE    IP            NODE   NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-pdwks        0/1     Completed   0          4m8s   10.42.0.175   k3s    <none>           <none>
ingress-nginx-admission-patch-rmp8g         0/1     Completed   1          4m8s   10.42.0.176   k3s    <none>           <none>
ingress-nginx-controller-57b7568757-kh42l   1/1     Running     0          4m8s   10.42.0.177   k3s    <none>           <none>
```
ingress-rule.yaml:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-ingress
  namespace: ingress-test
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
    - host: ingress.test1.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: nginx-svc
                port:
                  number: 80
```
```shell
sudo vim ingress-rule.yaml
sudo kubectl apply -f ingress-rule.yaml

```
æŸ¥çœ‹ï¼š
```shell
ubuntu@k3s:~/ingress_nginx$ sudo kubectl get ingress -n ingress-test
NAME           CLASS     HOSTS               ADDRESS        PORTS   AGE
test-ingress   traefik   ingress.test1.com   192.168.74.2   80      2m54s


ubuntu@k3s:~/ingress_nginx$ sudo kubectl describe ingress -n ingress-test
Name:             test-ingress
Labels:           <none>
Namespace:        ingress-test
Address:          192.168.74.2
Ingress Class:    traefik
Default backend:  <default>
Rules:
  Host               Path  Backends
  ----               ----  --------
  ingress.test1.com
                     /   nginx-svc:80 (10.42.0.171:80,10.42.0.172:80,10.42.0.173:80)
Annotations:         nginx.ingress.kubernetes.io/rewrite-target: /
Events:              <none>
```
è¿›å…¥ingresså®¹å™¨æŸ¥çœ‹ï¼š
```shell
ubuntu@k3s:~/ingress_nginx$ sudo kubectl get pod -n ingress-nginx
NAME                                        READY   STATUS      RESTARTS   AGE
ingress-nginx-admission-create-pdwks        0/1     Completed   0          46m
ingress-nginx-admission-patch-rmp8g         0/1     Completed   1          46m
ingress-nginx-controller-57b7568757-kh42l   1/1     Running     0          46m

# è¿›å…¥å®¹å™¨
ubuntu@k3s:~/ingress_nginx$ sudo kubectl exec -it -n ingress-nginx ingress-nginx-controller-57b7568757-kh42l -- /bin/sh
/etc/nginx $ cat nginx.conf
```
æŠŠä¹‹å‰é€šè¿‡svcçš„NodePortæš´éœ²ç«¯å£å»æ‰ï¼š
```shell
ubuntu@k3s:~/ingress_nginx$ sudo vim nginx.yaml
ubuntu@k3s:~/ingress_nginx$ sudo kubectl apply -f nginx.yaml
deployment.apps/nginx unchanged
service/nginx-svc configured
```

å»æ‰svcä¸­çš„ï¼š
```yaml
...
spec:
  type: NodePort
  ...
  ports:
    nodePort: 32133
```

ç»‘å®šhostsï¼š
`192.168.74.2 ingress.test1.com`

æµè§ˆå™¨è®¿é—®ï¼š
`http://ingress.test1.com/`
![/images/docImages/ks5.png](/images/docImages/ks5.png)





