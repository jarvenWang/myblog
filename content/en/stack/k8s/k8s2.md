---
author: "wangjinbao"
title: "k3s+multipasså®è·µk8sé›†ç¾¤æ“ä½œ"
date: 2023-06-23
description: "k8sçš„éƒ¨ç½²ã€ä½¿ç”¨ã€å·¥å…·ã€‚"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: wangjinbao
authorEmoji: ğŸ‘»
tags:
- k8s
categories:
- k8s
- k3s
- multipass
---

## k8sçš„ç»„ä»¶
### node
nodeæ˜¯K8Sé›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹


### pod
podæœ€å°å•å…ƒ
>ps:ä¸€ä¸ªpodä¸­æ˜¯å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ä¸­çš„

### service:svc
1. å†…éƒ¨æœåŠ¡ï¼šæ•°æ®åº“ã€åç«¯API
2. å¤–éƒ¨æœåŠ¡ï¼šå¾®æœåŠ¡APIã€å‰ç«¯ç•Œé¢

>å¤–éƒ¨æœåŠ¡ ä¸­åŒ…å« ï¼šnodePort å¤–éƒ¨ç«¯å£ï¼Œæ˜ å°„svcçš„ç«¯å£ï¼Œå³å¯è®¿é—®svc
> è¿™æ ·å³å¯é€šè¿‡ip + ç«¯å£ è®¿é—®æœåŠ¡

### ingress
æ˜¯ç”¨æ¥ç®¡ç†é›†ç¾¤å¤–éƒ¨è®¿é—®é›†ç¾¤å†…éƒ¨æœåŠ¡çš„å…¥å£å’Œæ–¹å¼çš„ï¼Œå¯èƒ½é€šè¿‡ingressæ¥é…ç½®ä¸åŒçš„ <font color='cyan'>è½¬å‘è§„åˆ™</font>
ingresså¯ä»¥<font color='cyan'>é…ç½®åŸŸå</font>ï¼Œè¿™æ ·ä»£æ›¿ ip + ç«¯å£çš„è®¿é—®æ–¹å¼,å¦å¤–å¯ä»¥é…ç½® <font color='cyan'>è´Ÿè½½å‡è¡¡</font>ã€<font color='cyan'>SSL</font> ç­‰
> ç”Ÿäº§ç¯å¢ƒéƒ½æ˜¯ç”¨åŸŸåè®¿é—®çš„

### ConfigMap
ConfigMap æŠŠé…ç½®ä¿¡æ¯å°è£…èµ·æ¥ï¼Œç„¶åå°±å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­è¯»å–å’Œä½¿ç”¨äº†
å¦‚ï¼š<font color='cyan'>URL username password</font>

> é¿å…ç”Ÿäº§ç¯å¢ƒ ä¸­çš„é…ç½®ä¿¡æ¯ç»å¸¸ä¿®æ”¹

### secret
åœ¨configMapçš„åŸºç¡€ä¸Š <font color='cyan'>åŠ å¯†ä¸€å±‚</font>ï¼Œè§£å†³æ•æ„Ÿé—®é¢˜ï¼Œå¦‚ï¼šbase64 + å…¶å®ƒçš„ç®—æ³•

### volumes
è§£å†³æ•°æ®çš„ <font color='cyan'>æŒä¹…åŒ–é—®é¢˜</font>ï¼Œ <font color='cyan'>æŒ‚è½½åˆ°é›†ç¾¤å¤–éƒ¨</font>çš„è¿œç¨‹å­˜å‚¨ä¸Š

### deployment
deployment è§£å†³å•ç‚¹nodeæŒ‚æ‰åçš„ <font color='cyan'>é«˜å¯ç”¨</font>ï¼Œå®ƒå¯ä»¥å®šä¹‰å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„å‰¯æœ¬æ•°é‡ï¼Œä»¥åŠåº”ç”¨ç¨‹åºçš„ <font color='cyan'>æ›´æ–°ç­–ç•¥</font>

>PS: ç†è§£æ€»ç»“
> podï¼šå¯ä»¥ç†è§£ä¸ºåœ¨ <font color='cyan'>å®¹å™¨ä¸ŠåŠ äº†ä¸€å±‚æŠ½è±¡</font>ï¼ŒæŠŠå¤šä¸ªå®¹å™¨æ”¾åœ¨ä¸€èµ·ç»„æˆpod
> deployment: å¯ä»¥ç†è§£ä¸ºåœ¨ <font color='cyan'>podä¸ŠåŠ äº†ä¸€å±‚æŠ½è±¡</font> ï¼Œå°†ä¸€ä¸ªæˆ–å¤šä¸ªpodç»„åˆåœ¨ä¸€èµ·ï¼Œå¹¶ä¸”è¿˜æœ‰å‰¯æœ¬æ§åˆ¶ã€æ»šåŠ¨æ›´æ–°ã€è‡ªåŠ¨æ‰©ç¼© ç­‰

### statefulSet
é’ˆå¯¹podè‡ªåŠ¨åˆ é™¤ã€æ–°å¢ã€æ›´æ–°ç­‰æ“ä½œï¼Œæ•°æ®åº“çš„æŒä¹…åŒ–çš„é—®é¢˜ï¼Œå› æ­¤ä¸€äº› <font color='cyan'>æœ‰çŠ¶æ€</font> çš„åº”ç”¨ï¼Œå¦‚:<font color='cyan'>æ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—</font> ç­‰ï¼Œéƒ½è¦ä½¿ç”¨ statefulSet
>PS: ä¸€èˆ¬æœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œå¦‚ <font color='cyan'>æ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—</font>ç­‰éƒ½ä»ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œåœ¨ç¾¤é›†å¤–å•ç‹¬éƒ¨ç½²ã€‚

## k8sæ¶æ„
<font color='cyan'>master - worker</font> æ¶æ„
### master-node
<font color='cyan'>master-node</font> è´Ÿè´£ç®¡ç†æ•´ä¸ªé›†ç¾¤
![/images/docImages/ks2.png](/images/docImages/ks2.png)
ç”±4ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š
+ apiServer
+ etcd
+ controllerManager
+ scheduler
+ cloudControllerManager

#### apiServer
æä¾›k8sé›†ç¾¤çš„APIæ¥å£æœåŠ¡ï¼Œæ‰€æœ‰çš„ç»„ä»¶éƒ½ä¼šé€šè¿‡è¿™ä¸ªæ¥å£æ¥è¿›è¡Œé€šä¿¡ï¼Œå¦‚ï¼š kubectlã€DashBoard ç­‰ å·¥å…·ã€‚
å¹¶ä¸”podçš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œè¿›è¡Œè®¤è¯ã€æˆæƒå’Œè®¿é—®æ§åˆ¶

#### scheduler
è´Ÿè´£ <font color='cyan'>ç›‘æ§èµ„æºå¹¶åè°ƒè°ƒåº¦</font>ä½¿ç”¨

#### controllerManager
å½“podå‘ç”Ÿæ•…éšœæ—¶ï¼Œç›‘æ§å’Œæ£€æµ‹åˆ°è¿™ä¸ªæ•…éšœï¼Œç„¶åå¿«é€Ÿå¤„ç†ã€‚å¦‚ï¼š<font color='cyan'>é‡æ–°å¯åŠ¨pod</font>ã€<font color='cyan'>å…¶å®ƒpodä»£æ›¿å®ƒ</font>

#### etcd
é«˜å¯ç”¨çš„ <font color='cyan'>é”®-å€¼å­˜å‚¨ç³»ç»Ÿ</font>ï¼Œç”¨æ¥å­˜å‚¨æ‰€æœ‰èµ„æºå¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ¯ä¸ªpodçš„ä¿¡æ¯éƒ½è®°å½•åœ¨é‡Œé¢ï¼ˆé›†ç¾¤çš„å¤§è„‘ï¼‰


#### cloudControllerManager
äº‘å¹³å°æœåŠ¡ç‰¹æœ‰çš„

### worker-node
<font color='cyan'>worker-node</font> è´Ÿè´£è¿è¡Œåº”ç”¨ç¨‹åºå’ŒæœåŠ¡
![/images/docImages/ks1.png](/images/docImages/ks1.png)
ä¸ºäº†æ¯ä¸ªnodeéƒ½èƒ½æ­£å¸¸è¿è¡Œï¼ŒnodeåŒ…å«ä¸‰ä¸ªç»„ä»¶ï¼š
+ kubeletï¼š<font color='cyan'>ç»´æŠ¤æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„pod</font>ï¼Œå¹¶ç¡®ä¿å®ƒæŒ‰é¢„æœŸè¿è¡Œï¼Œå®šæœŸä»apiServerä¸­æ›´æ–°ä¿®æ”¹åçš„podè§„èŒƒï¼Œ<font color='cyan'>ç›‘æ§èŠ‚ç‚¹çš„è¿è¡Œæƒ…å†µ</font>ï¼Œæ±‡æŠ¥ç»™apiServer
+ kube-proxyï¼šä¸ºpodå¯¹è±¡æä¾› <font color='cyan'>ç½‘ç»œä»£ç† å’Œ è´Ÿè½½å‡è¡¡</font> æœåŠ¡
+ container-runtime: <font color='cyan'>æ‹‰å–ã€åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å®¹å™¨</font>

>é€šå¸¸ä¸€ä¸ªserviceä¸­ç”±å¤šä¸ªnode(èŠ‚ç‚¹)ç»„æˆï¼Œè¿™ä¸ªserviceçš„è´Ÿè½½å‡è¡¡å°±æ˜¯é€šè¿‡kube-proxyå®Œæˆçš„


## k3s + multipass
### å®‰è£…multipass
multipasså®˜ç½‘åœ°å€ï¼š
`https://multipass.run/`
mac:
`brew install multipass`
éªŒè¯ï¼š
`multipass version`
 åˆ›å»ºè™šæ‹Ÿæœº
`multipass launch --name k3s --cpus 2 --memory 8G --disk 10G`
æŸ¥çœ‹
`multipass list`
ç›¸å…³å‘½ä»¤ï¼š
+ åˆ›å»ºè™šæ‹Ÿæœºï¼š `multipass launch --name k3s`
+ å¯åŠ¨è™šæ‹Ÿæœºï¼š `multipass start k3s`
+ åœæ­¢è™šæ‹Ÿæœºï¼š `multipass stop k3s`
+ è¿›å…¥è™šæ‹Ÿæœºï¼š `multipass shell k3s`
+ æ‰§è¡Œå‘½ä»¤ï¼š `multipass exec k3s -- ls -l`
+ æŸ¥çœ‹è™šæ‹Ÿæœºåˆ—è¡¨ï¼š `multipass list`
+ æŸ¥çœ‹å¸®åŠ©ï¼š `multipass help`

k3sé»˜è®¤ä¸å…è®¸è¿œç¨‹ç™»å½•çš„ï¼Œå¦‚æœæƒ³ä½¿ç”¨SSHç™»å½•è™šæ‹Ÿæœºçš„è¯ï¼Œå¯ä»¥æŒ‰ä¸‹æ­¥éª¤ï¼š
1. ç™»å½•è™šæ‹Ÿæœºï¼š `multipass shell k3s`
2. å®‰è£… net-tools: `sudo apt install net-tools`
3. ä¿®æ”¹sshé…ç½®ï¼š `vi /etc/ssh/sshd_config`
   (PassWordAuthentication no=>yes å’Œ PermitRootLogin yes å’Œ sudo service ssh restart)

4. è®¾ç½®å¯†ç ï¼š`passwd`
```shell
sudo passwd ubuntu
è®¾ç½®å¯†ç 
```
é€€å›ä¸»æœºæµ‹è¯•ç™»å½•ï¼š
```shell
ssh ubuntu@192.168.105.10
```
5. ç”Ÿæˆç§˜é’¥ï¼š`ssh-keygen`
```shell
ssh-keygen -t rsa -b 4096
cd .ssh
id_rsa.pub
```

6. é…ç½®å…å¯†ç™»å½•ï¼š`ssh-copy-id ubuntu@192.168.105.10`
7. ç®€åŒ–å‘½ä»¤ï¼š `alias k3s='ssh ubuntu@192.168.105.10'`
æ·»åŠ åˆ°bashå„zshçš„é…ç½®æ–‡ä»¶ ä¸­

### å®‰è£…k3s
è¿›å…¥åˆ°k3sè™šæ‹Ÿæœºä¸­è¿›è¡Œå®‰è£… k3s:
#### å®‰è£…k3sçš„masterèŠ‚ç‚¹
```shell
curl -sfL https://get.k3s.io | sh -
```
å›½å†…ç”¨æˆ·å¯ä»¥æ¢æˆä¸‹é¢çš„å‘½ä»¤ï¼Œä½¿ç”¨ranherçš„é•œåƒæºæ¥å®‰è£…ï¼š
```shell
curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -
# æŸ¥çœ‹
$ sudo kubectl get nodes
NAME   STATUS   ROLES                  AGE   VERSION
k3s    Ready    control-plane,master   11s   v1.29.3+k3s1
```

æ¥ä¸‹æ¥éœ€è¦åœ¨è¿™ä¸ªmasterèŠ‚ç‚¹ä¸Šè·å–ä¸€ä¸ªtokenï¼Œ
ç”¨æ¥ä½œä¸ºåˆ›å»ºworkerèŠ‚ç‚¹æ—¶çš„ä¸€ä¸ªè®¤è¯å‡­è¯ï¼Œ
å®ƒä¿å­˜åœ¨/var/lib/rancher/k3s/server/node-tokenè¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œ
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨sudo catå‘½ä»¤æ¥æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œ
```shell
sudo cat /var/lib/rancher/k3s/server/node-token
```
é€€å‡ºk3sè™šæ‹Ÿä¸»æœºï¼š
#### å°†TOKENä¿å­˜åˆ°ä¸€ä¸ªç¯å¢ƒå˜é‡ä¸­
```shell
TOKEN=$(multipass exec k3s sudo cat /var/lib/rancher/k3s/server/node-token)
```

#### ä¿å­˜masterèŠ‚ç‚¹çš„IPåœ°å€
```shell
MASTER_IP=$(multipass info k3s | grep IPv4 | awk '{print $2}')
```
ç¡®è®¤
```shell
echo $MASTER_IP
```

ä½¿ç”¨åˆšåˆšçš„TOKENå’ŒMASTER_IPæ¥åˆ›å»ºä¸¤ä¸ªworkerèŠ‚ç‚¹
å¹¶æŠŠå®ƒä»¬åŠ å…¥åˆ°é›†ç¾¤ä¸­
#### åˆ›å»ºä¸¤ä¸ªworkerèŠ‚ç‚¹çš„è™šæ‹Ÿæœº
```shell
multipass launch --name worker1 --cpus 2 --memory 8G --disk 10G
multipass launch --name worker2 --cpus 2 --memory 8G --disk 10G
```

#### åœ¨workerèŠ‚ç‚¹è™šæ‹Ÿæœºä¸Šå®‰è£…k3s
```shell
for f in 1 2; do
multipass exec worker$f -- bash -c "curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL=\"https://$MASTER_IP:6443\" K3S_TOKEN=\"$TOKEN\" sh -"
done
```

è¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ªå¤šèŠ‚ç‚¹çš„kubernetesé›†ç¾¤çš„æ­å»ºã€‚

## k8sçš„å¸¸ç”¨å‘½ä»¤
### åŸºç¡€ä½¿ç”¨
```shell
# æŸ¥çœ‹å¸®åŠ©
kubectl --help

# æŸ¥çœ‹APIç‰ˆæœ¬
kubectl api-versions

# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
kubectl cluster-info
```

### èµ„æºçš„åˆ›å»ºå’Œè¿è¡Œ
```shell
# åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªæŒ‡å®šçš„é•œåƒ
kubectl run NAME --image=image [params...]
# e.g. åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªåå­—ä¸ºnginxçš„Pod
kubectl run nginx --image=nginx

# æ ¹æ®YAMLé…ç½®æ–‡ä»¶æˆ–è€…æ ‡å‡†è¾“å…¥åˆ›å»ºèµ„æº
kubectl create RESOURCE
# e.g.
# æ ¹æ®nginx.yamlé…ç½®æ–‡ä»¶åˆ›å»ºèµ„æº
kubectl create -f nginx.yaml
# æ ¹æ®URLåˆ›å»ºèµ„æº
kubectl create -f https://k8s.io/examples/application/deployment.yaml
# æ ¹æ®ç›®å½•ä¸‹çš„æ‰€æœ‰é…ç½®æ–‡ä»¶åˆ›å»ºèµ„æº
kubectl create -f ./dir

# é€šè¿‡æ–‡ä»¶åæˆ–æ ‡å‡†è¾“å…¥é…ç½®èµ„æº
kubectl apply -f (-k DIRECTORY | -f FILENAME | stdin)
# e.g.
# æ ¹æ®nginx.yamlé…ç½®æ–‡ä»¶åˆ›å»ºèµ„æº
kubectl apply -f nginx.yaml
```
### æŸ¥çœ‹èµ„æºä¿¡æ¯
```shell
# æŸ¥çœ‹é›†ç¾¤ä¸­æŸä¸€ç±»å‹çš„èµ„æº
kubectl get RESOURCE
# å…¶ä¸­ï¼ŒRESOURCEå¯ä»¥æ˜¯ä»¥ä¸‹ç±»å‹ï¼š
kubectl get pods / po         # æŸ¥çœ‹Pod
kubectl get svc               # æŸ¥çœ‹Service
kubectl get deploy            # æŸ¥çœ‹Deployment
kubectl get rs                # æŸ¥çœ‹ReplicaSet
kubectl get cm                # æŸ¥çœ‹ConfigMap
kubectl get secret            # æŸ¥çœ‹Secret
kubectl get ing               # æŸ¥çœ‹Ingress
kubectl get pv                # æŸ¥çœ‹PersistentVolume
kubectl get pvc               # æŸ¥çœ‹PersistentVolumeClaim
kubectl get ns                # æŸ¥çœ‹Namespace
kubectl get node              # æŸ¥çœ‹Node
kubectl get all               # æŸ¥çœ‹æ‰€æœ‰èµ„æº

# åé¢è¿˜å¯ä»¥åŠ ä¸Š -o wide å‚æ•°æ¥æŸ¥çœ‹æ›´å¤šä¿¡æ¯
kubectl get pods -o wide

# æŸ¥çœ‹æŸä¸€ç±»å‹èµ„æºçš„è¯¦ç»†ä¿¡æ¯
kubectl describe RESOURCE NAME
# e.g. æŸ¥çœ‹åå­—ä¸ºnginxçš„Podçš„è¯¦ç»†ä¿¡æ¯
kubectl describe pod nginx
```

### èµ„æºçš„ä¿®æ”¹ã€åˆ é™¤å’Œæ¸…ç†
```shell
# æ›´æ–°æŸä¸ªèµ„æºçš„æ ‡ç­¾
kubectl label RESOURCE NAME KEY_1=VALUE_1 ... KEY_N=VALUE_N
# e.g. æ›´æ–°åå­—ä¸ºnginxçš„Podçš„æ ‡ç­¾
kubectl label pod nginx app=nginx

# åˆ é™¤æŸä¸ªèµ„æº
kubectl delete RESOURCE NAME
# e.g. åˆ é™¤åå­—ä¸ºnginxçš„Pod
kubectl delete pod nginx

# åˆ é™¤æŸä¸ªèµ„æºçš„æ‰€æœ‰å®ä¾‹
kubectl delete RESOURCE --all
# e.g. åˆ é™¤æ‰€æœ‰Pod
kubectl delete pod --all

# æ ¹æ®YAMLé…ç½®æ–‡ä»¶åˆ é™¤èµ„æº
kubectl delete -f FILENAME
# e.g. æ ¹æ®nginx.yamlé…ç½®æ–‡ä»¶åˆ é™¤èµ„æº
kubectl delete -f nginx.yaml

# è®¾ç½®æŸä¸ªèµ„æºçš„å‰¯æœ¬æ•°
kubectl scale --replicas=COUNT RESOURCE NAME
# e.g. è®¾ç½®åå­—ä¸ºnginxçš„Deploymentçš„å‰¯æœ¬æ•°ä¸º3
kubectl scale --replicas=3 deployment/nginx

# æ ¹æ®é…ç½®æ–‡ä»¶æˆ–è€…æ ‡å‡†è¾“å…¥æ›¿æ¢æŸä¸ªèµ„æº
kubectl replace -f FILENAME
# e.g. æ ¹æ®nginx.yamlé…ç½®æ–‡ä»¶æ›¿æ¢åå­—ä¸ºnginxçš„Deployment
kubectl replace -f nginx.yaml
```

### è°ƒè¯•å’Œäº¤äº’
```shell
# è¿›å…¥æŸä¸ªPodçš„å®¹å™¨ä¸­
kubectl exec [-it] POD [-c CONTAINER] -- COMMAND [args...]
# e.g. è¿›å…¥åå­—ä¸ºnginxçš„Podçš„å®¹å™¨ä¸­ï¼Œå¹¶æ‰§è¡Œ/bin/bashå‘½ä»¤
kubectl exec -it nginx -- /bin/bash

# æŸ¥çœ‹æŸä¸ªPodçš„æ—¥å¿—
kubectl logs [-f] [-p] [-c CONTAINER] POD [-n NAMESPACE]
# e.g. æŸ¥çœ‹åå­—ä¸ºnginxçš„Podçš„æ—¥å¿—
kubectl logs nginx

# å°†æŸä¸ªPodçš„ç«¯å£è½¬å‘åˆ°æœ¬åœ°
kubectl port-forward POD [LOCAL_PORT:]REMOTE_PORT [...[LOCAL_PORT_N:]REMOTE_PORT_N]
# e.g. å°†åå­—ä¸ºnginxçš„Podçš„80ç«¯å£è½¬å‘åˆ°æœ¬åœ°çš„8080ç«¯å£
kubectl port-forward nginx 8080:80

# è¿æ¥åˆ°ç°æœ‰çš„æŸä¸ªPodï¼ˆå°†æŸä¸ªPodçš„æ ‡å‡†è¾“å…¥è¾“å‡ºè½¬å‘åˆ°æœ¬åœ°ï¼‰
kubectl attach POD -c CONTAINER
# e.g. å°†åå­—ä¸ºnginxçš„Podçš„æ ‡å‡†è¾“å…¥è¾“å‡ºè½¬å‘åˆ°æœ¬åœ°
kubectl attach nginx

# è¿è¡ŒæŸä¸ªPodçš„å‘½ä»¤
kubectl run NAME --image=image -- COMMAND [args...]
# e.g. è¿è¡Œåå­—ä¸ºnginxçš„Pod
kubectl run nginx --image=nginx -- /bin/bash
```

### minikube
è¦å…ˆå¼€å¯æœåŠ¡
```shell
minikube start
```
### multipass
è¦å…ˆè¿›å…¥masterèŠ‚ç‚¹
```shell
multipass shell k3s
```
#### å‘½ä»¤
æŸ¥çœ‹èŠ‚ç‚¹ï¼š

`sudo kubectl get nodes`
æŸ¥çœ‹serviceï¼š
`sudo kubectl get svc`
æŸ¥çœ‹podï¼š
`sudo kubectl get pod`
åˆ›å»ºpod:
`sudo kubectl run nginx --image=nginx`
åˆ›å»ºèµ„æºå¯¹è±¡ï¼š
`sudo kubectl create ...`
åˆ›å»ºdeployment:
```shell
sudo kubectl create deployment nginx-deployment --image=nginx

$ sudo kubectl get pod
NAME                                READY   STATUS    RESTARTS   AGE
nginx                               1/1     Running   0          24m
nginx-deployment-6d6565499c-lv4s4   1/1     Running   0          22m
```
>PS : åå­—ä¸­å¯ä»¥çœ‹å‡º deployment å’Œ pod ä¹‹é—´è¿˜æœ‰ä¸€ä¸ª replicaset (6d6565499c),
> nginx-deployment:ä»£è¡¨ deployment çš„åç§°
> 6d6565499cï¼šä»£è¡¨ replicaset çš„éšæœºæ•°
> lv4s4ï¼šä»£è¡¨ pod çš„éšæœºæ•°
```shell
$ sudo kubectl get replicaset
NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-6d6565499c   1         1         1       25m
```
ç¼–è¾‘èµ„æºå¯¹è±¡ï¼š
```shell
sudo kubectl edit deployment nginx-deployment
è¿›å…¥ vimç¼–è¾‘å™¨
```
æŸ¥çœ‹æ—¥å¿—ï¼š
```shell
$ sudo kubectl logs nginx-deployment-6d6565499c-lv4s4
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
```
è¿›å…¥pod:
```shell
$ sudo kubectl exec -it nginx-deployment-6d6565499c-lv4s4 -- /bin/bash
root@nginx-deployment-6d6565499c-lv4s4:/#
```
åˆ é™¤èµ„æºå¯¹è±¡(deployment)
```shell
sudo kubectl delete deployment nginx-deployment
ä¹‹åç›¸å°±çš„replicaset å’Œ pod éƒ½ä¼šè¢«åˆ é™¤
```

## yamlæ–‡ä»¶çš„é…ç½®å’Œä½¿ç”¨
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 3
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
        ports:
        - containerPort:80
```
### é€šè¿‡yamlæ–‡ä»¶ï¼š
åˆ›å»ºdeploymentèµ„æºå¯¹è±¡
```shell
sudo kubectl create -f nginx-deployment.yaml
```
åˆ é™¤deployment:
```shell
sudo kubectl delete -f nginx-deployment.yaml
```
>PS:create å’Œ apply çš„åŒºåˆ«ï¼šæ–°å¢ å’Œ æ›´æ–°æˆ–æ–°å¢



## k8sé…ç½®é¡¹è¯¦è§£
```yaml
# ä¸APIserveräº¤äº’æŒ‡å®š group/version
apiVersion: apps/v1  
# èµ„æºå¯¹è±¡çš„ç±»å‹ï¼šDeployment/ Service/ ConfigMap
kind: Deployment
# å®šä¹‰èµ„æºå¯¹è±¡çš„å…ƒæ•°æ®ï¼šåç§°ã€æ ‡ç­¾ã€å‘½ä»¤ç©ºé—´
metadata:
  name: kibana
  namespace: logging
# è§„èŒƒï¼Œæ˜¯specificationçš„ç¼©å†™ï¼Œé…ç½®å¤šä¸ªèµ„æºå¯¹è±¡çš„ä¿¡æ¯ï¼šå¤šå‰¯æœ¬ã€é•œåƒã€ç«¯å£ç­‰
# specæ˜¯ä¸€ä¸ªåµŒå¥—çš„ç»“æ„ï¼Œç¬¬ä¸€ä¸ªspecæ˜¯deploymenté…ç½®ä¿¡æ¯ï¼Œç¬¬äºŒä¸ªæ˜¯podçš„é…ç½®ä¿¡æ¯ï¼Œ
spec:
  # é€‰æ‹©å™¨ == Labels æ ‡ç­¾
  selector:
    matchLabels:
      app: kibana
  # å‰¯æœ¬çš„ä¸ªæ•°
  replicas: 3
  # å®šä¹‰äº†podçš„é…ç½®ä¿¡æ¯
  template:
    metadata:
      labels:
        app: kibana
    spec:
      containers:
        - name: kibana
          # é•œåƒåœ°å€
          image: docker.elastic.co/kibana/kibana:6.5.4
          # ç¯å¢ƒå˜é‡
          env:
            - name: ELASTICSEARCH_URL
              value: http://elasticsearch:9200
            - name: XPACK_SECURITY_ENABLED
              value: "true"
          ports:
            # å¯¹å¤–æš´éœ²çš„ç«¯å£æ˜¯ 5601
            - containerPort: 5601
              name: http
              protocol: TCP
```
### åˆ›å»º èµ„æºå¯¹è±¡ï¼š
```shell
kubectl create apply -f kibana-deploment.yaml
```
### åˆ é™¤ èµ„æºå¯¹è±¡ï¼š
```shell
kubectl delete -f kibana-deploment.yaml
```

### åˆ›å»º/æ›´æ–° èµ„æºå¯¹è±¡
```shell
kubectl apply -f kibana-deploment.yaml
```
>PS : ç”Ÿäº§é‡åˆ°æµé‡é«˜å³°ï¼Œä¿®æ”¹replicasæ•°é‡ï¼Œå¹¶æ‰§è¡Œapply -f å°±å¯ä»¥è¿…é€Ÿæ‰©å®¹

>PS :Service ä¸­æ²¡æœ‰ `replicas` å˜é‡ï¼ŒconfigMap ä¸­æ²¡æœ‰ `selector` å˜é‡

### æŸ¥çœ‹Ipå’ŒèŠ‚ç‚¹
å‘½ä»¤ï¼š
```shell
kubectl get pod -o wide
```

### åˆ›å»ºæœåŠ¡
```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
```
![/images/docImages/ks3.png](/images/docImages/ks3.png)
åˆ›å»ºæœåŠ¡ å‘½ä»¤ï¼š
```shell
kubectl create service nginx-service
```
å°†å·²å­˜åœ¨çš„ deployment å¯¹å¤–å…¬å¼€ä¸ºä¸€ä¸ªæœåŠ¡ å‘½ä»¤ï¼š
(<font color='cyan'>å°†deploymentå‡çº§ä¸ºä¸€ä¸ªservice</font>)
```shell
kubectl expose deployment nginx-deployment

ubuntu@k3s:~$ sudo kubectl get all
...
NAME                       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
service/kubernetes         ClusterIP   10.43.0.1     <none>        443/TCP   18h
>>>>>> service/nginx-deployment   ClusterIP   <font color='cyan'>10.43.7.225</font>   <none>        80/TCP    10s 
...
```
è®¿é—®è¿™ä¸ªæœåŠ¡ï¼š
```shell
curl 10.43.7.225
```


æŸ¥çœ‹ **æœåŠ¡** è¯¦ç»†ä¿¡æ¯ 
å‘½ä»¤ï¼š
```shell
sudo kubectl describe service nginx-deployment
sudo kubectl describe deployment nginx-deployment
sudo kubectl describe pod nginx-deployment-cd5968d5b-g94t2
```

æŸ¥çœ‹ **deployment** è¯¦ç»†ä¿¡æ¯
å‘½ä»¤ï¼š
```shell
sudo kubectl describe deployment nginx-deployment
```

### åˆ é™¤æœåŠ¡
```shell
sudo kubectl delete service nginx-deployment
```

### æä¾›å¯¹å¤–ç«¯å£æœåŠ¡
![/images/docImages/ks4.png](/images/docImages/ks4.png)
ç«¯å£å·å¿…é¡»åœ¨ <font color='cyan'>30000</font> åˆ° <font color='cyan'>32767</font> ä¹‹é—´
```yaml
spec:
  # æŒ‡å®šç±»å‹
  type: NodePort
  ports:
    .
    .
    .
    nodePort: 30080
```
æ›´æ–°é…ç½®ï¼š
```shell
sudo kubectl apply -f nginx-service.yaml
service/nginx-service configured

# æŸ¥çœ‹typeå˜ä¸ºNodePort
$ sudo kubectl  get all
...
NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/kubernetes      ClusterIP   10.43.0.1       <none>        443/TCP        18h
service/nginx-service   NodePort    10.43.133.154   <none>        80:30080/TCP   4m
...
```

æŸ¥çœ‹èŠ‚ç‚¹çš„ipåœ°å€ï¼š
```shell
$ sudo kubectl  get nodes -o wide
NAME      STATUS   ROLES                  AGE   VERSION        INTERNAL-IP    EXTERNAL-IP   OS-IMAGE           KERNEL-VERSION     CONTAINER-RUNTIME
worker2   Ready    <none>                 18h   v1.29.3+k3s1   192.168.65.4   <none>        Ubuntu 24.04 LTS   6.8.0-31-generic   containerd://1.7.11-k3s2
k3s       Ready    control-plane,master   18h   v1.29.3+k3s1   192.168.65.2   <none>        Ubuntu 24.04 LTS   6.8.0-31-generic   containerd://1.7.11-k3s2
worker1   Ready    <none>                 18h   v1.29.3+k3s1   192.168.65.3   <none>        Ubuntu 24.04 LTS   6.8.0-31-generic   containerd://1.7.11-k3s2
```
æµè§ˆå™¨è®¿é—®ï¼š
å› ä¸ºæ˜¯é›†ç¾¤è®¿é—®å“ªä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥ï¼š
`192.168.65.2:30080`
`192.168.65.3:30080`
`192.168.65.4:30080`

![/images/docImages/ks5.png](/images/docImages/ks5.png)

### serviceæœåŠ¡çš„ç§ç±»
+ #### ClusterIP 
<font color='cyan'>é»˜è®¤ç±»å‹</font>ï¼Œé›†ç¾¤å†…éƒ¨çš„æœåŠ¡
+ #### NodePort 
<font color='cyan'>èŠ‚ç‚¹ç«¯å£ç±»å‹</font>ï¼Œå°†æœåŠ¡å…¬å¼€åˆ°é›†ç¾¤èŠ‚ç‚¹ä¸Š
+ #### LoadBalancer 
<font color='cyan'>è´Ÿè½½å‡è¡¡ç±»å‹</font>ï¼Œå°†æœåŠ¡å…¬å¼€åˆ°å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ä¸Š
+ #### ExternalName 
<font color='cyan'>å¤–éƒ¨åç§°ç±»å‹</font>ï¼Œå°†æœåŠ¡æ˜ å°„åˆ°ä¸€ä¸ªå¤–éƒ¨åŸŸåä¸Š
+ #### Headless 
<font color='cyan'>æ— å¤´ç±»å‹</font>ï¼Œä¸»è¦ç”¨äºDNSè§£æå’ŒæœåŠ¡å‘ç°

## portainerå¯è§†åŒ–ç®¡ç†é›†ç¾¤
### å®‰è£…Portainer
```shell
# ä¸‹è½½yamlæ–‡ä»¶ï¼š
wget https://downloads.portainer.io/ce2-19/portainer.yaml
# å®‰è£…
$ sudo kubectl apply -n portainer -f portainer.yaml
namespace/portainer created
serviceaccount/portainer-sa-clusteradmin created
persistentvolumeclaim/portainer created
clusterrolebinding.rbac.authorization.k8s.io/portainer created
service/portainer created
deployment.apps/portainer created
# --æˆ–è€…ç›´æ¥å®‰è£…
# åœ¨masterèŠ‚ç‚¹ä¸Šå®‰è£…portainerï¼Œå¹¶å°†å…¶æš´éœ²åœ¨NodePort 30777ä¸Š
kubectl apply -n portainer -f https://downloads.portainer.io/ce2-19/portainer.yaml

```
æŸ¥çœ‹ï¼š
æŒ‡å®šå‘½åç©ºé—´ï¼š`-n`
```shell
sudo kubectl  get all -n portaine
```
### è®¿é—®
httpåè®®ï¼š
http://192.168.65.2:30777/
httpsåè®®ï¼š
https://192.168.65.2:30779/

![/images/docImages/ks6.png](/images/docImages/ks6.png)
å‰æè¦è¿VPNï¼šä¸ç„¶ä¼šæŠ¥é”™ï¼š
>New Portainer installation
>Your Portainer instance timed out for security purposes. To re-enable your Portainer instance, you will need to restart Portainer.

æ ¹æ®yamlé…ç½®æ–‡ä»¶ åˆ é™¤èµ„æºå¯¹è±¡
```shell
sudo kubectl delete -f portainer.yaml
```
é¦–æ¬¡è®¾ç½®adminå¯†ç ï¼š
admin
wjb1234509876

![/images/docImages/ks7.png](/images/docImages/ks7.png)

![/images/docImages/ks8.png](/images/docImages/ks8.png)