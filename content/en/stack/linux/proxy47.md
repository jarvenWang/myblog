---
author: "wangjinbao"
title: "Nginx负载均衡中4层代理和7层代理的区别"
date: 2022-01-01 00:00:01
description: "Nginx负载均衡中4层代理和7层代理的区别"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: wangjinbao
authorEmoji: 👻
tags: 
- linux
- categories:
#  -
#image: images/feature3/go.png
---


## 一、4层代理和7层代理什么意思？
这里的层是OSI 7层网络模型，OSI 模型是从上往下的，越底层越接近硬件，越往上越接近软件，这七层模型分别是：
<font color='#aed581'>物理层、数据链路层、网络层、传输层、会话层、表示层、应用层</font>。

+ 4层 是指传输层的 tcp / udp 。

+ 7层 是指应用层，通常是http 。

## 二、OSI模型
OSI（开放系统互联）网络模型是一个用于理解和描述计算机网络功能和协议的参考模型。它定义了将网络通信划分为七个不同的层级，每个层级都描述了特定的功能和任务，从物理传输到应用层。

为了方便记忆，可以使用以下助记词或短语来代表每个层级的名称：

1. 物：物理层（Physical Layer）- 提供传输介质和机械、电气、功能和过程特性，用于直接传输数据比特流。

2. 链：数据链路层（Data Link Layer）- 负责在直连的网络节点之间可靠地传输数据帧，并管理物理地址。

3. 网：网络层（Network Layer）- 处理分组在网络中的路由和转发，使数据能够跨越多个网络进行传输。

4. 传：传输层（Transport Layer）- 提供端到端的可靠数据传输，处理数据分段、重组、流量控制和错误恢复。

5. 会话：会话层（Session Layer）- 管理建立、维护和终止应用程序之间的会话。

6. 表示：表示层（Presentation Layer）- 处理数据的表示形式，包括数据格式、数据加密和数据压缩。

7. 应用：应用层（Application Layer）- 提供网络应用程序与网络服务之间的接口，这是最高级的层级。


## 三、代理原理
4层 用的是NAT技术。NAT英文全称是“Network Address Translation”，中文意思是“网络地址转换”，请求进来的时候，nginx修改数据包里面的目标和源IP和端口，然后把数据包发向目标服务器，服务器处理完成后，nginx再做一次修改，返回给请求的客户端。

7层代理：需要读取并解析http请求内容，然后根据具体内容(url,参数，cookie,请求头)然后转发到相应的服务器，转发的过程是：建立和目标机器的连接，然后转发请求，收到响应数据在转发给请求客户端。

在Nginx负载均衡中，4层代理和7层代理是两种不同的代理模式，它们的区别主要体现在所操作的网络层级和负载均衡的粒度上。

4层代理（也被称为传输层代理）是在传输层（即网络层）上进行负载均衡的一种代理方式。它通过检查传输层的头部信息（如源IP地址、目标IP地址和端口号）来决定将请求转发到后端服务器的哪个节点。4层代理是基于网络层的信息进行路由和负载均衡，能够处理更高的并发请求，但在实现复杂的应用层路由策略方面有限。

7层代理（也被称为应用层代理）是在应用层进行负载均衡的一种代理方式。它能够解析和处理应用层协议（如HTTP、HTTPS等），并根据应用层的内容来决定请求的转发。7层代理不仅可以基于传输层的信息进行负载均衡，还能够根据请求的路径、域名、Cookie等更具体的应用层信息来进行路由和负载均衡。因此，7层代理更加灵活，能够实现复杂的路由和负载均衡策略，适合处理有状态的应用。

总结来说，4层代理基于网络层的信息进行负载均衡，适用于处理高并发请求，而7层代理则基于应用层的信息进行负载均衡，具备更灵活的路由和负载均衡策略，适用于处理有状态的应用。选择使用哪种代理方式取决于具体的应用场景和负载均衡需求。

## 四、优缺点对比：
### 1、性能：
理论上4层要比7层快，因为7层代理需要解析数据包的具体内容，需要消耗额外的cpu。但nginx具体强大的网络并发处理能力， 对于一些慢连接，nginx可以先将网络请求数据缓冲完了一次性转发给上游server,这样对于上游网络并发处理能力弱的服务器(比如tomcat)，这样对tomcat来说就是慢连接变成快连接(nginx到tomcat基本上都是可靠内网),从而节省网络数据缓冲时间，提供并发性能。

### 2、灵活性：
  由于4层代理用的是NAT，所以nginx不知道请求的具体内容，所以nginx啥也干不了。 用7层代理，可以根据请求内容(url,参数，cookie,请求头)做很多事情，比如：

+ a:动态代理：不同的url转发到不同服务器。

+ b.风控：屏蔽外网IP请求某些敏感url；根据参数屏蔽某些刷单用户。

+ c.审计：在nginx层记录请求日志。




