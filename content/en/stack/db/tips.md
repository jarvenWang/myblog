---
author: "wangjinbao"
title: "数仓建设规范"
date: 2023-05-20
description: "介绍企业IT数仓建设体系、架构和数据仓库开发规范，并附上实际案例加以说明，为数据仓库建设工作提供规范标准和指导建议。"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: wangjinbao
authorEmoji: 👻
tags:
- db
- categories:

---
## 1、引言
### 1.1目标与范围
介绍企业IT数仓建设体系、架构和数据仓库开发规范，并附上实际案例加以说明，为数据仓库建设工作提供规范标准和指导建议。
### 1.2适用对象
1)数据仓库设计人员
2)数据仓库开发人员
3)数据仓库运维人员
4)数据需求对接人
### 1.3相关参考
【1】【腾讯视频】离线数仓建设规范化流程实践
https://km.woa.com/group/47744/articles/show/441043?sessionKey=TE746fC4fhrE7zhbRc1QrvdYxWOT7MT0
【2】滴滴数据仓库指标体系建设实践
https://km.woa.com/group/44229/articles/show/441343
【3】维度建模和指标体系构建
https://km.woa.com/group/47744/articles/show/444548
【4】《大数据之路-阿里巴巴大数据实践》《数据仓库工具箱-维度建模权威指南》
### 1.4数仓建设准则
（1）规范性    保证数据架构分层规范性、数据接入规范性、数据仓库开发规范性。
（2）一致性    通过领域驱动和一数一源理念保证数据的一致性，统一数据语言，从而进一步保证数据的可信性和数仓建设的灵活性。
（3）扩展性    模型建设要具备可扩展性，保证能灵活支持元数据变更、数据迁移、数据需求变更等需求。
（4）时效性    数据采集、处理、查询要具备满足业务需求的高时效保障。
（5）灵活性    支持多场景的报表新增需求，支持报表的灵活变更需求。
（6）安全性    保证全生命周期的数据安全，包括但不限于数据采集、传输、处理、存储、消费、共享过程中的安全。

## 2数仓体系整体设计
![/images/docImages/img_1.png](/images/docImages/dataware.png)
+ <b>业务视角</b>：依照公司管理职能和数据领域划分业务板块，如企业集团的IT数据管理领域等；其中，IT业务板块又可以根据业务职能划分为相对独立的业务域，如HR、财务等；一个完整的业务域一般由三类数据构成，分别是：基础数据（又叫参考数据）、交易数据、主数据。
+ <b>交易数据区</b>：一般根据业务事项产生，具有事务发生日期属性，属于事务性数据，也是具体的业务过程数据存储区。
+ <b>基础数据区</b>：基础数据存储的是时间周期或者修饰词信息，是描述业务数据的数据，一般引用外部标准或者战略业务等的配置数据，如管理架构、平台产品、业务渠道等具备管理视角的数据，未来可形成维表或衍生指标。
+ <b>业务主数据区</b>：一般来源于业务系统，结构及内容与业务系统完全一致，如人员信息表、组织架构、财务科目等。
## 3数仓库架构设计
### 3.1 架构图

![/images/docImages/img_1.png](/images/docImages/dataware1.png)

### 3.2架构分区说明
数据仓库模型建设的核心内容是DW和ADS数据层建设，且遵循Kimball模型建设理论，其他层的数据逻辑模型可参照上层数据的模型进行迁移转化。

#### 3.2.1 ODS
| 中文名    | 数据预处理区  |
|--------| ----  |
| 英文全名   | Operational Data Store |
| 模型设计说明 | 主要包含业务数据库快照数据、运营埋点数据、其他业务等数据 |
| 数据类型   | 交易数据、基础数据、业务主数据 |
| 表类型    | 事务事实表（增量表）|周期事实表（快照表）|拉链表 |
| ETL工作  | 1）同步：结构化数据增量或全量同步到数据仓库；2）结构化：非结构化数据结构化处理后同步到数据仓库；3）保存历史4）数据预处理：根据数据业务需求校验数据、过滤数据，进行基础的数据预处理工作 |
| 备注     | 业务覆盖度要恰当，尽量覆盖关键核心的业务数据 |

#### 3.2.2 TMP
|  中文名   | 临时数据区  |
|  ----  | ----  |
| 英文全名  | Tempare Data Store |
| 模型设计说明  | 临时层， 数据处理的辅助处理层，服务DWD、DWS 层，主要是一些临时存储的数据 |
| 数据类型  | 业务数据、基础数据、主数据 |
| 表类型  | 全量事实表 |
| ETL工作  | 数据抽取加载，不涉及数据处理 |
| 备注  | 根据自定义需求、尽量不要占用资源、需及时清除数据 |

#### 3.2.3 DW
+ BMD

|  中文名   | 业务主数据区|
|  ----  | ----  |
| 英文全名  | Business Master Data |
| 模型设计说明  | 核心业务对象，自动定期从业务源系统同步 |
| 数据类型  | 主数据 |
| 表类型  | 拉链表|快照表 |
| ETL工作  | 主数据集成（主数据也可以被直接统计为数据指标、也可以作为分析维度） |
| 备注  | 业务主数据区数据模型相对交易数据区的数据模型会稳定很多 |

+ DWD

|  中文名   | 数据仓库明细层  |
|  ----  | ----  |
| 英文全名  | Data Warehouse Detail |
| 模型设计说明  | 存储经过标准规范化处理(即数据清洗)后的运营数据，是基础事实数据明细层。实例:行为事件明细表、MySQL 各业务数据经过 ETL 处理后的实体表 |
| 数据类型  | 业务数据 |
| 表类型  | 事务事实表|周期快照事实表|累计快照事实表 |
| ETL工作  | 参考数据资产目录数据业务域划分标准，按业务域聚合交 |
| 备注  | 数据模型能满足指标建设需求，模型中各个事务的维度粒度要保持一致，且要求维度的最细粒度，覆盖度越高完善度越好 |

+ DIM

|  中文名   | 数据仓库维度表层  |
|  ----  | ----  |
| 英文全名  | Dimension data |
| 模型设计说明  | 维度数据层，主要包含一些业务维度数据。实例：地区表，订单状态，支付方式，审批状态，商品分类，商品型号，渠道类型、终端类型、广告位、红包计划等 |
| 数据类型  | 基础数据 |
| 表类型  | 拉链表 |
| ETL工作  | 建立一致数据分析维表，降低数据计算口径、算法不统一的风险 |
| 备注  | 模型是所有数据类型中最稳定的，能支持对指标分析维度进行灵活的下钻与聚合分析 |



+ DWS

|  中文名   | 数据公共汇总层  |
|  ----  | ----  |
| 英文全名  | Data Warehouse Summery |
| 模型设计说明  | 按数据业务域进行划分，支持 OLAP 分析、数据分发等，其信息主要来源于 DWD 层汇总后的数据。实例:财务损益明细汇总表 |
| 数据类型  | 主题域OLAP数据模型数据分析区 |
| 表类型  | 累计快照表 |
| ETL工作  | 本数据区域根据依据指标矩阵负责从技术加工、业务一致性等共性方向将生成公共数据，为下游数据提供单一的数据口径输出，最大化实现一次加工多次使用 |
| 备注  | 该区域模型一般采用的星花模型，支持对多项同粒度的业务过程进行多维度的分析，分析的指标粒度具有通用性，是报表分析较其他数据区引用度最高的数据区 |


+ DM(数据集市)

|  中文名   | 数据集市  |
|  ----  | ----  |
| 英文全名  | Data Mart |
| 模型设计说明  | 数据集市就是满足特定的部门或者用户的需求，按照多维的方式进行存储，包括定义维度、需要计算的指标、维度的层次等，生成面向决策分析需求的数据立方体，一般是一个存储衍生指标的指标库 |
| 数据类型  | 主题域星型模型数据区，大宽表物化视图区 |
| 表类型  | 累计快照表 |
| ETL工作  | 在数据仓库领域，该层根据业务需求从DWS抽取加工数据，建立汇总宽表、支持报表分析 |
| 备注  | 属于高粒度多维度聚合的数据模型区，也称为立方体（cube），往往直接支持决策层和管理层的报表需求，场景简单时，此层可省略 |



#### 3.2.4 MDW

|  中文名   | 元数据信息层  |
|  ----  | ----  |
| 英文全名  | Meta Data Warehouse |
| 模型设计说明  | 元数据机制主要支持以下五类系统管理功能：1、描述哪些数据在数据仓库中; 2、定义要进入数据仓库中的数据和从数据仓库中产生的数据; 3、记录根据业务事件发生而随之进行的数据抽取工作时间安排; 4、记录并检测系统数据一致性的要求和执行情况; 5、衡量数据质量。 |
| 数据类型  | 元数据 |
| 表类型  | 拉链表|全量快照表 |
| ETL工作  | 本数据区，直接集成数据库的元数据信息 |
| 备注  | 根据数据资产管理、数据资产分析需求进行建模 |



#### 3.2.5 ADS
|  中文名   | 应用数据层  |
|  ----  | ----  |
| 英文全名  | Application Database Service |
| 模型设计说明  | 面向具体应用的表，要创建在这层，一般一些特定应用的个性化处理的复杂指标或者数据表会放在这层 |
| 数据类型  | 应用主题数据 |
| 表类型  | 全量表|增量表|快照表 |
| ETL工作  | 在数据仓库领域，该层根据业务需求从ods/dwd/dws/dm抽取加工数据，对数据做如下处理：1）个性化指标加工：不公用性、复杂性指标（指数型、排名型，比值型）；2）对应用数据进行组装：大宽表、行转列表、趋势指标串、画像分析等 |
| 备注  |  |


## 4数据仓库开发规范
### 4.1 指标管理规范
#### 4.1.1 指标分析流程说明

指标建设首先需要确定数据的业务板块（一般对应数据资产目录的数据域分组），在将指标需求根据其业务定义拆解成为业务过程和业务对象，将业务过程拆解出分析维度和原子指标，最终进一步生成派生指标，其中业务对象及其属性以及派生指标中的修饰词和时间周期也可以作为事实表的维度属性，业务过程将被作为事实表。具体关系及示例如下图：

![/images/docImages/img_1.png](/images/docImages/dataw1.png)
![/images/docImages/img_1.png](/images/docImages/dataw2.png)

#### 4.1.2 指标命名规范
（1）命名原则
●统一性：保持全局一致、唯一
●可读性：遵循指标分析流程、英文简写清晰易懂、不易产生歧义
●易维护性：具有明确的规则
●可扩展性：长度限制以及组合规则可支持业务指标扩展
（2） 规则定义
原子指标：[动作]+[业务对象]+度量
【示例】打卡员工数：cki_emp_cnt
衍生指标：[时间周期] +[修饰词]+原子指标([动作]+[业务对象]+度量)
【示例】上周迟到打卡的女员工数：lw_late_cki_emp_f_cnt
复合指标：[时间周期] +[修饰词]+原子指标([动作]+[业务对象]+度量)
【示例】上周迟到打卡的女员工占比：lw_late_cki_emp_f_rat
（3） 组成规则说明
●常见统计时间周期列表
中文名	英文名	中文名	英文名
最近1天	1d	当前月	cm
最近7天	7d	当前季度	cq
最近1个月	1m	截止当日	td
最近1小时	1h	年初累计到当日	ytd
未来7天	f1w	月初累计到当日	mtd
本周	cw	上周	lw
●常见业务对象列表
业务主体	英文全称	英文简称
组织	organization	org
项目	project	proj
合同	contract	contr
产品	product	prod
渠道	channel	chnnl
订单	order	order
……	……	……
●常见度量列表
度量类型	英文名	英文缩写
计数	count	cnt
计金额	amount	amt
占比	rate	rat

### 4.2 数据模型开发规范
#### 4.2.1 数据模型开发指引
（1）表级开发指引说明
|  表类型   | 说明  |开发指引  |
|  ----  | ----  | ----  |
| 拉链缓慢变化表  | 保存一个业务对象全生命周期的数据，通过对业务对象代理键更新插入的方式加载数据 | 必须增加业务主键级别的start_dt,end_dt，另外要有数据接入时间，对象生成时间，数据来源信息 |
| 快照表-缓慢变化表  | 按照更新时间分区保持当前状态的全部对象数据，业务过程或对象当前状态和前一天状态没有关系，增量方式加载数据，通过日期限制查询对象当前状态，通过业务代理键查询业务全生命周期数据 | 必须按当前更新时间dt作为分区字段，另外要有数据接入时间，事务生成时间，数据来源信息 |
| 快照表-周期变化表  | 按照更新时间分区保持当前状态的全量数据，业务过程或者对象当前状态与之前的状态相关，采用增量加载 | 必须按当前更新时间dt作为分区字段，另外要有数据接入时间，事务生成时间，数据来源信息 |
| 快照表-事务增量表  | 日志型或者事务型数据，当前数据和历史数据业务主键完全不相关，增量加载就行 | 需具备数据接入时间，事务生成时间，数据来源信息 |



（2）字段开发指引说明

|  字段类型   | 说明  | 开发指引  |
|  ----  | ----  | ----  |
| ID字段  | 表自生成的自然键 | 流水号，长度最好不要超过21位 |
| 关联维度  | 对应维度信息的代理键和名称，或者只有代理键或名称 | 维度管理最好具备外键ID或者外键编码，同时具备维度Id 值对应的name值 |
| 日期字段  | 业务元数据日期或者管理元数据日期 | Hive、clickhouse中的日期字段统一采用字符串类型存储，时间戳除外 |
| 时间字段  | 业务元数据时间或者管理元数据时间 | Hive、clickhouse中的日期字段统一采用字符串类型存储，时间戳除外 |
| 指标字段  |  | 只能为数值型，控制精度 |
| 编码字段  | 外部唯一标识，代理键 | 编码字段，必须保证编码的可读性、可扩展性和一致性 |


（3）表间开发指引说明
|  关系类型   | 说明  | 开发指引  |
|  ----  | ----  | ----  |
| 业务对象各个业务过程关联  | 业务过程按照最细粒度进行对象关联 | 通过一致性最细粒度业务对象编码关联 |
| 桥接表关联  | 具有映射关系的三个表关联，一般是跨系统编码映射，标准对齐等 |  |
| 父子表关联  | 具有层级关系的维度表 | 表需具备上级的编码或者ID |


#### 4.2.2 数据模型命名规范
（1）命名原则
●统一性：全局唯一，统一使用小写字母，表名统一由字母和下划线（_）组成
●可读性：标准化管理规则，英文简称清晰易懂，避免歧义
●易维护性：具有明确的规则
●可扩展性：长度限制支持对象新增和迁移可扩展；
●稳定性：名称一旦确定，全生命周期保持不变
##### 4.2.2.1 表命名规范
(1)公式及样例
![/images/docImages/img_1.png](/images/docImages/dw1.png)
![/images/docImages/img_1.png](/images/docImages/dw2.png)
![/images/docImages/img_1.png](/images/docImages/dw3.png)
![/images/docImages/img_1.png](/images/docImages/dw4.png)
（3）规则说明
●更新方式
|  更新方式   | 编码  | 编码说明  |
|  ----  | ----  | ----  |
| 全量  | f | full的缩写 |
| 增量  | i | increase的缩写 |

●存储方式
|  存储方式   | 编码  | 编码说明  |
|  ----  | ----  | ----  |
| 拉链表  | z | zip的缩写 |
| 快照表  | s | snapshot的缩写 |

●时间粒度
|  时间粒度   | 编码  | 编码说明  |
|  ----  | ----  | ----  |
| 每天更新  | 1d | day |
| 每周更新  | 1w | week |
| 每月更新  | 1m | month |
| 每2小时更新  | 2h | hour |
| 每5分钟更新  | 5min | minute |

●分区信息
|  分区   | 编码  | 编码说明  |
|  ----  | ----  | ----  |
| 分区表  | p | partition |
| 非分区表  | / |  |



##### 4.2.2.2 字段命名规范
对字段进行标准命名需遵循两个过程：
●确定标准字段（原子字段）
标准字段一般由实体+字段属性组成
●遵循继承关系
对衍生字段确定其所继承的原子字段，从而保障字段的属性一直，例如：“投保人号”、“被保人号”，本质为“客户号”。在设计表字段时，它们都将从标准字段（客户号）继承，具有与标准字段相同的数据类型（长度/精度）、数据格式、校验规则、默认值。
（1）规则定义
|  公式   | [修饰词]_ [业务主体]_ [业务过程]_属性字段_[标识主体]|
|  ----  | ----  |
| 公式说明  | []表示可有字段，‘标识字段’是属于主体的标签字段，一般是主体的属性的具体属性值，或者业务过程的状态 |


|     | |   | |   | |   | |
|  ----  | ----  |  ----  | ----  |  ----  | ----  |  ----  | ----  |
| 基本信息字段 | 字段中文名称 | 修饰词 | 业务主体 | 业务过程 | 属性字段 | 标识主体 | 字段名称|
| 基本信息字段  | 组织名 | / | org || name | / | org_name | 
|  基本信息字段  | 合同审批状态 |  /  | cntrct  |  approval  | status  |  /  | cntrct_approval_status  |
|  指标字段  | QQ音乐下载 |  qqmusic  | user  |  down  | cn  |  /  | qqmusic_user_down_cn  |
|  日期字段  | 注册日期  |  /  |  | reg  |  date  | /  |  reg_date  | 
|  时间字段  | 修改时间  |  /  |   |  upd  | time  |  /  | upd_time  |
|  判断字段  | 是否完成  |  /  |   |    | is  |  finish  | is_finish  |
|  判断字段  | 是否新员工  |  /  | /  |  /  | is  |  new_emp  | is_new_emp  |


### 4.3 其他规范

+ 所有层 ：ds字段，date类型，格式2023-04-05，取跑任务的当前时间；但是ODS层例外，ODS层沿用之前的逻辑，写的是跑任务的当前时间的前一天；query_effdt字段，varchar类型，格式2023-04-05；在Starrocks里面，如果需要用到这个字段来做分区，可以做成date类型；DWD以上的层，对null字段都需要处理为''，也就是空字符串
+ ODS：
  1.ds字段：日期分区字段，date类型，格式2023-04-05，每天凌晨跑数时取跑数时-1的日期作为该字段的值（虽然更好的是去跑数当天的日期，但是以前的逻辑都已经取T-1，所以就沿用过去的逻辑）。
  2.bs_flag字段：是否补跑标记
  3.加密方式：跟原敏感仓一致，使用别名“HR_CRYPTIC_DW”对需要加密的字段进行加密；加密盐为emplid字段，如果没有emplid字段，则使用deptid，如果也没有则根据业务系统特点选字段，但是要在“数据备注”中注明。

## 5、样例说明
为了更清晰的说明数据仓库各个核心数据区具体的模型和数据关系，初步以HR域的HR门户和集音社两个系统的订单相关表和员工信息表为例，进行数仓建设和相关的指标分析，具体模型关系图如下：
![/images/docImages/img_1.png](/images/docImages/dataw3.png)

